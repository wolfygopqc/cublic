<!DOCTYPE html> 
<html lang="fr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cublic</title>
    <style>
        :root {
            --primary-color: #5294e2;
            --secondary-color: #75b0f8;
            --success-color: #2ecc71;
            --energy-color: #f1c40f;
            --happiness-color: #9b59b6;
            --background-image: url('https://www.bungie.net/img/destiny_content/pgcr/background_decal.png'), radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
            --surface-color: rgba(15, 20, 25, 0.85);
            --border-color: rgba(130, 170, 220, 0.4);
            --border-radius: 8px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #0c1014 var(--background-image) no-repeat center center fixed;
            color: white;
            overflow: hidden;
            margin: 0;
            height: 100dvh;
            width: 100dvw;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #game-container {
            height: 100%;
            width: 100%;
            position: relative;
        }

        .screen {
            position: absolute;
            inset: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s, visibility 0.5s;
            background: transparent;
            box-sizing: border-box;
        }

        .screen.active {
            opacity: 1;
            visibility: visible;
        }

        #main-menu {
            text-align: center;
            background: var(--background-image);
        }

        #main-menu h1 {
            font-size: 4rem;
            color: white;
            margin-bottom: 2rem;
        }

        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            width: 300px;
        }

        .menu-btn {
            padding: 1rem;
            font-size: 1.2rem;
            font-weight: bold;
            background-color: var(--primary-color);
            color: white;
            border: 1px solid var(--border-color);
            clip-path: polygon(0 0, calc(100% - 8px) 0, 100% 8px, 100% 100%, 8px 100%, 0 calc(100% - 8px));
            cursor: pointer;
            transition: all 0.2s;
        }

        .menu-btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        .menu-btn:disabled {
            background-color: rgba(0, 0, 0, 0.2);
            border-color: rgba(130, 170, 220, 0.2);
            color: #999;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        #game-screen {
            flex-direction: column;
        }

        .actions-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        #time-display {
            font-size: 1.2rem;
            font-weight: bold;
        }

        #money-display {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .stat-bar-container {
            width: 120px;
            height: 15px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
        }
        .stat-bar {
            width: 100%;
            height: 100%;
            transition: width 0.2s linear;
        }
        #hunger-bar { background-color: #e67e22; }
        #energy-bar { background-color: var(--energy-color); }
        #happiness-bar { background-color: var(--happiness-color); }
        #health-bar { background-color: #e74c3c; }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal-content {
            background-color: var(--surface-color);
            backdrop-filter: blur(10px);
            padding: 2rem;
            border: 1px solid var(--border-color);
            clip-path: polygon(0 0, calc(100% - 20px) 0, 100% 20px, 100% 100%, 20px 100%, 0 calc(100% - 20px));
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .job-listing {
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .business-listing {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            border-radius: 0;
            margin-bottom: 0;
        }
        .business-listing .owned-tag {
            color: var(--success-color);
            font-weight: bold;
            background-color: transparent;
            padding: 0.5rem 1rem;
            border: 2px solid var(--success-color);
            border-radius: var(--border-radius);
        }
        .business-details {
            font-size: 0.9rem;
            color: #ccc;
        }

        #map-modal .modal-content {
            width: 100%;
            height: 100%;
            max-width: none;
            border-radius: 0;
            padding: 0;
        }

        #map-modal-content {
            position: relative;
        }

        #game-screen {
            display: grid;
            grid-template-columns: 1fr;
            grid-template-rows: 80px 1fr;
            grid-template-areas:
                "header header"
                "main main";
            align-items: start;
            background: var(--background-image);
            width: 100%;
            height: 100%;
        }

        #header {
            grid-area: header;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
            background-color: var(--surface-color);
            border-bottom: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
        }

        #main-content {
            grid-area: main;
            padding: 2rem;
            box-sizing: border-box;
        }

        #main-content > .panel {
            height: calc(100vh - 80px - 4rem);
            overflow-y: auto;
        }

        #sidebar {
            grid-area: sidebar;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            color: white;
        }
        
        #phone-dock {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            background-color: var(--surface-color);
            padding: 10px;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            z-index: 1001;
        }

        .app-icon {
            width: 60px;
            height: 60px;
            font-size: 2rem;
            border-radius: 12px;
            background-color: rgba(0,0,0,0.2);
            border: none;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .app-icon:hover {
            background-color: var(--primary-color);
            transform: translateY(-5px);
        }

        #phone-screen {
            position: fixed;
            bottom: 105px;
            left: 50%;
            transform: translateX(-50%);
            width: 380px;
            height: 500px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, bottom 0.3s, width 0.3s, height 0.3s;
            pointer-events: none;
        }

        #phone-screen.active {
            opacity: 1;
            visibility: visible;
            bottom: 115px;
            pointer-events: all;
        }

        #phone-screen.wide {
            width: 700px;
            height: 500px;
        }


        .panel {
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            backdrop-filter: blur(10px);
            clip-path: polygon(0 0, calc(100% - 15px) 0, 100% 15px, 100% 100%, 15px 100%, 0 calc(100% - 15px));
        }

        .panel h2 {
            margin: 0 0 1rem 0;
            font-size: 1.2rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }

        #map-modal-content #map-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        #map-icons-container {
            position: absolute;
            inset: 0;
            pointer-events: none;
        }

        #map-info-panel {
            position: absolute;
            top: 0;
            right: -400px;
            width: 350px;
            height: 100%;
            background-color: var(--surface-color);
            box-shadow: -5px 0 15px rgba(0,0,0,0.2);
            transition: right 0.3s ease-in-out;
            padding: 1.5rem;
            box-sizing: border-box;
            overflow-y: auto;
        }

        #map-info-panel.active {
            right: 0;
        }

        #map-info-panel h2 {
            margin-top: 0;
            color: var(--primary-color);
        }

        #map-legend {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            justify-content: center;
        }

        #staff-button {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 100px;
            height: 100px;
            z-index: 1002;
            cursor: pointer;
        }
    </style>
</head>
<body>

<div id="game-container">
    <div id="main-menu" class="screen active">
        <div class="panel">
            <h1>Cublic</h1>
            <div class="menu-buttons">
                <button id="new-game-btn" class="menu-btn">Nouvelle Partie</button>
                <button id="continue-btn" class="menu-btn">Continuer</button>
                <button id="options-btn" class="menu-btn">Options</button>
            </div>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <header id="header">
            <button id="back-to-menu-btn" class="menu-btn" style="padding: 0.5rem 1rem; font-size: 1rem;">Menu</button>
            <div id="time-display">Jour 1 - 08:00</div>
            <div id="money-display">500 $</div>
        </header>

        <main id="main-content">
            <div class="panel">
                <h2 id="main-panel-title">Actions</h2>
                <div id="contextual-actions" style="max-height: calc(100% - 80px); overflow-y: auto;"></div>
                <button id="travel-btn" class="menu-btn" style="margin-top: 1rem;">Se D√©placer</button>
            </div>
        </main>

        <div id="phone-dock">
            <button class="app-icon" id="status-app-btn" title="Statut">üë§</button>
            <button class="app-icon" id="needs-app-btn" title="Besoins">‚ù§Ô∏è</button>
            <button class="app-icon" id="bank-app-btn" title="Banque">üè¶</button>
            <button class="app-icon" id="portfolio-app-btn" title="Portfolio">üíº</button>
            <button class="app-icon" id="stocks-app-btn" title="Bourse">üìà</button>
            <button class="app-icon" id="jobs-app-btn" title="Emploi">üëî</button>
            <button class="app-icon" id="social-app-btn" title="Social">üí¨</button>
            <button class="app-icon" id="inventory-app-btn" title="Inventaire">üéí</button>
            <button class="app-icon" id="properties-app-btn" title="Propri√©t√©s">üîë</button>
            <button class="app-icon" id="ranking-app-btn" title="Classement">üèÜ</button>
            <button class="app-icon" id="delivery-app-btn" title="Livraison">üçî</button>
            <button class="app-icon" id="objectives-app-btn" title="Objectifs">üéØ</button>
        </div>

        <div id="staff-button"></div>

        <div id="phone-screen"></div>
    </div>
</div>

<div id="travel-modal" class="modal-overlay">
    <div class="modal-content">
        <h2>O√π voulez-vous aller ?</h2>
        <div id="locations-list"></div>
    </div>
</div>

<div id="staff-modal" class="modal-overlay">
    <div class="modal-content">
        <h2>Menu Staff</h2>
        <div id="staff-choices" class="menu-buttons" style="margin-top: 1rem;"></div>
        <button id="close-staff-btn" class="menu-btn" style="margin-top: 1rem;">Fermer</button>
    </div>
</div>

<div id="options-modal" class="modal-overlay">
    <div class="modal-content">
        <h2>Options</h2>
        <p>Attention, la r√©initialisation est d√©finitive.</p>
        <button id="reset-game-btn" class="menu-btn" style="margin-top: 1rem; background-color: #c0392b;">R√©initialiser la Partie</button>
        <button id="close-options-btn" class="menu-btn" style="margin-top: 1rem;">Fermer</button>
    </div>
</div>

<div id="event-modal" class="modal-overlay">
    <div class="modal-content">
        <h2 id="event-title"></h2>
        <p id="event-description"></p>
        <div id="event-choices" class="menu-buttons" style="margin-top: 1rem;"></div>
    </div>
</div>

<div id="history-modal" class="modal-overlay">
    <div class="modal-content">
        <h2>Historique des Transactions</h2>
        <div id="history-list"></div>
        <button id="close-history-btn" class="menu-btn" style="margin-top: 1rem;">Fermer</button>
    </div>
</div>

<div id="sleep-modal" class="modal-overlay">
    <div class="modal-content">
        <h2>Combien de temps dormir ?</h2>
        <div id="sleep-options" class="menu-buttons" style="margin-top: 1rem;"></div>
        <button id="cancel-sleep-btn" class="menu-btn" style="margin-top: 1rem; background-color: #c0392b;">Annuler</button>
    </div>
</div>

<div id="sell-modal" class="modal-overlay">
    <div class="modal-content">
        <h2 id="sell-modal-title">Offres d'achat</h2>
        <div id="offers-list"></div>
        <button id="refuse-sell-btn" class="menu-btn" style="margin-top: 1rem; background-color: #c0392b;">Refuser tout</button>
    </div>
</div>

<div id="sleep-animation" class="modal-overlay" style="background-color: rgba(0,0,0,0.95); font-size: 4rem; color: white; pointer-events: none; z-index: 9999;">
    <div style="position: relative; width: 100px; height: 100px;">
        <span style="position: absolute; animation: float 2s ease-in-out infinite;">Z</span>
        <span style="position: absolute; animation: float 2s ease-in-out infinite 0.5s;">z</span>
        <span style="position: absolute; animation: float 2s ease-in-out infinite 1s;">z</span>
    </div>
</div>
<style>
    @keyframes float {
        0%, 100% { transform: translateY(0) translateX(0) scale(1); opacity: 1; }
        50% { transform: translateY(-40px) translateX(10px) scale(1.5); opacity: 0.5; }
    }
</style>

<div id="inventory-modal" class="modal-overlay">
    <div class="modal-content">
        <h2>Inventaire</h2>
        <div id="inventory-list"></div>
        <button id="close-inventory-btn" class="menu-btn" style="margin-top: 1rem;">Fermer</button>
    </div>
</div>

<div id="notification-container"></div>
<style>
    #notification-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; flex-direction: column; gap: 0.5rem; }
    .notification { padding: 1rem; border-radius: var(--border-radius); color: white; font-weight: bold; box-shadow: 0 2px 10px rgba(0,0,0,0.5); opacity: 0; transform: translateY(-20px); animation: fadeInOut 4s ease-in-out forwards; }
    .notification.success { background-color: var(--success-color); }
    .notification.error { background-color: #e74c3c; }
    .notification.info { background-color: var(--primary-color); }
    @keyframes fadeInOut { 0%, 100% { opacity: 0; transform: translateY(-20px); } 10%, 90% { opacity: 1; transform: translateY(0); } }
</style>

<div id="news-ticker">
    <div id="news-ticker-content"></div>
</div>
<style>
    #news-ticker { position: fixed; bottom: 20px; right: 20px; width: 350px; height: 60px; background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: var(--border-radius); overflow: hidden; z-index: 1000; display: flex; align-items: center; justify-content: center; text-align: center; }
    #news-ticker-content { padding: 0.5rem; font-size: 1.1rem; transition: opacity 0.5s ease-in-out; }
</style>

<div id="player-status-ticker">
    <div id="player-status-content"></div>
</div>
<style>
    #player-status-ticker { position: fixed; bottom: 20px; left: 20px; width: 350px; height: 60px; background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: var(--border-radius); overflow: hidden; z-index: 1000; display: flex; align-items: center; justify-content: center; text-align: center; }
    #player-status-content { padding: 0.5rem; font-size: 1.1rem; font-style: italic; color: #ccc; }
</style>
    <script>
        const SAVE_KEY = 'cublicSaveState';
        const GAME_TICK_MS = 50;

        const mainMenuScreen = document.getElementById('main-menu');
        const gameScreen = document.getElementById('game-screen');

        let gameState = null;
        let gameInterval = null;
        let autosaveInterval = null;
        let playerStatusInterval = null;
        let newsTickerInterval = null;
        let shuffledNews = [];
        let currentNewsIndex = 0;

        const restaurantData = {
            'pizza_palace': { name: 'Pizza Palace', category: 'Italien', menu: [
                { id: 'pizza_margherita', name: 'Pizza Margherita', cost: 22, hungerBonus: 55, happinessBonus: 8 },
                { id: 'pizza_royale', name: 'Pizza Royale', cost: 28, hungerBonus: 60, happinessBonus: 10 },
                { id: 'pasta_carbonara', name: 'P√¢tes Carbonara', cost: 24, hungerBonus: 65, happinessBonus: 8 }
            ]},
            'sushi_zen': { name: 'Sushi Zen', category: 'Japonais', menu: [
                { id: 'sushi_assortment', name: 'Assortiment de Sushi (18p)', cost: 45, hungerBonus: 50, happinessBonus: 15 },
                { id: 'miso_soup', name: 'Soupe Miso', cost: 6, hungerBonus: 15, happinessBonus: 2 },
                { id: 'ramen_tonkotsu', name: 'Ramen Tonkotsu', cost: 22, hungerBonus: 70, happinessBonus: 12 }
            ]},
            'burger_joint': { name: 'Burger Joint', category: 'Fast-Food', menu: [
                { id: 'classic_burger', name: 'Classic Burger', cost: 16, hungerBonus: 60, happinessBonus: 4 },
                { id: 'double_burger', name: 'Double Burger & Frites', cost: 21, hungerBonus: 70, happinessBonus: 5 },
                { id: 'chicken_wings', name: 'Ailes de Poulet (x6)', cost: 14, hungerBonus: 35, happinessBonus: 6 }
            ]},
            'healthy_bites': { name: 'Healthy Bites', category: 'Sain', menu: [
                { id: 'salad_cesar', name: 'Grande Salade C√©sar', cost: 19, hungerBonus: 40, happinessBonus: 2 },
                { id: 'quinoa_bowl', name: 'Bowl de Quinoa & L√©gumes', cost: 21, hungerBonus: 45, happinessBonus: 5 },
                { id: 'smoothie_green', name: 'Smoothie Vert D√©tox', cost: 9, hungerBonus: 20, happinessBonus: 3 }
            ]},
            'taco_fiesta': { name: 'Taco Fiesta', category: 'Mexicain', menu: [
                { id: 'taco_trio', name: 'Trio de Tacos', cost: 18, hungerBonus: 55, happinessBonus: 7 },
                { id: 'burrito_grande', name: 'Burrito Grande', cost: 22, hungerBonus: 75, happinessBonus: 6 },
                { id: 'quesadillas', name: 'Quesadillas au Fromage', cost: 15, hungerBonus: 40, happinessBonus: 5 }
            ]},
            'wok_roll': { name: 'Wok & Roll', category: 'Chinois', menu: [
                { id: 'chow_mein', name: 'Nouilles Saut√©es (Chow Mein)', cost: 18, hungerBonus: 60, happinessBonus: 6 },
                { id: 'dumplings', name: 'Dim Sum (8 pi√®ces)', cost: 20, hungerBonus: 45, happinessBonus: 9 },
                { id: 'general_tao', name: 'Poulet G√©n√©ral Tao', cost: 24, hungerBonus: 65, happinessBonus: 8 }
            ]},
            'curry_house': { name: 'Curry House', category: 'Indien', menu: [
                { id: 'butter_chicken', name: 'Poulet au Beurre', cost: 26, hungerBonus: 60, happinessBonus: 11 },
                { id: 'samosas', name: 'Samosas aux l√©gumes (x3)', cost: 10, hungerBonus: 30, happinessBonus: 5 },
                { id: 'palak_paneer', name: 'Palak Paneer', cost: 23, hungerBonus: 55, happinessBonus: 9 }
            ]},
            'bangkok_street': { name: 'Bangkok Street Food', category: 'Tha√Ø', menu: [
                { id: 'pad_thai', name: 'Pad Tha√Ø', cost: 21, hungerBonus: 65, happinessBonus: 10 },
                { id: 'green_curry', name: 'Curry Vert au Poulet', cost: 24, hungerBonus: 60, happinessBonus: 11 },
                { id: 'spring_rolls', name: 'Rouleaux de Printemps (x4)', cost: 12, hungerBonus: 30, happinessBonus: 6 }
            ]},
            'le_pho': { name: 'Le Pho', category: 'Vietnamien', menu: [
                { id: 'pho_bo', name: 'Soupe Pho au Boeuf', cost: 19, hungerBonus: 70, happinessBonus: 10 },
                { id: 'banh_mi', name: 'Sandwich Banh Mi', cost: 14, hungerBonus: 50, happinessBonus: 7 }
            ]},
            'olympus_grill': { name: 'Olympus Grill', category: 'Grec', menu: [
                { id: 'gyros', name: 'Pita Gyros', cost: 17, hungerBonus: 65, happinessBonus: 7 },
                { id: 'souvlaki', name: 'Brochettes Souvlaki', cost: 28, hungerBonus: 55, happinessBonus: 9 }
            ]},
            'la_creperie': { name: 'La Cr√™perie', category: 'Fran√ßais', menu: [
                { id: 'crepe_complete', name: 'Cr√™pe Compl√®te', cost: 18, hungerBonus: 45, happinessBonus: 8 },
                { id: 'crepe_nutella', name: 'Cr√™pe Nutella Banane', cost: 12, hungerBonus: 30, happinessBonus: 12 }
            ]},
            'salty_dog': { name: 'The Salty Dog', category: 'Fruits de mer', menu: [
                { id: 'fish_chips', name: 'Fish & Chips', cost: 23, hungerBonus: 60, happinessBonus: 6 },
                { id: 'oysters', name: 'Hu√Ætres (x6)', cost: 30, hungerBonus: 25, happinessBonus: 14 }
            ]},
            'grill_master': { name: 'The Grill Master', category: 'Steakhouse', menu: [
                { id: 'ribeye', name: 'Steak Ribeye (300g)', cost: 55, hungerBonus: 70, happinessBonus: 18 },
                { id: 'ribs', name: 'C√¥tes Lev√©es BBQ', cost: 38, hungerBonus: 80, happinessBonus: 12 }
            ]},
            'morning_glory': { name: 'The Morning Glory', category: 'Brunch', menu: [
                { id: 'pancakes', name: 'Pancakes au Sirop d\'√ârable', cost: 19, hungerBonus: 50, happinessBonus: 10 },
                { id: 'eggs_benedict', name: 'Oeufs B√©n√©dictine', cost: 24, hungerBonus: 55, happinessBonus: 11 }
            ]},
            'sweet_dreams': { name: 'Sweet Dreams', category: 'Desserts', menu: [
                { id: 'cheesecake', name: 'Part de Cheesecake', cost: 11, hungerBonus: 20, happinessBonus: 15 },
                { id: 'ice_cream', name: 'Coupe de Glace (3 boules)', cost: 8, hungerBonus: 15, happinessBonus: 13 }
            ]},
            'sandwich_co': { name: 'The Sandwich Co.', category: 'Sandwicherie', menu: [
                { id: 'club_sandwich', name: 'Club Sandwich', cost: 16, hungerBonus: 50, happinessBonus: 5 },
                { id: 'italian_sub', name: 'Sous-marin Italien', cost: 18, hungerBonus: 60, happinessBonus: 6 }
            ]},
            'vegan_vibes': { name: 'Vegan Vibes', category: 'Vegan', menu: [
                { id: 'vegan_burger', name: 'Burger Vegan', cost: 22, hungerBonus: 55, happinessBonus: 7 },
                { id: 'tofu_scramble', name: 'Tofu Brouill√©', cost: 19, hungerBonus: 45, happinessBonus: 6 }
            ]},
            'bbq_pit': { name: 'The BBQ Pit', category: 'BBQ', menu: [
                { id: 'pulled_pork', name: 'Sandwich Porc Effiloch√©', cost: 20, hungerBonus: 70, happinessBonus: 9 },
                { id: 'brisket', name: 'Tranches de Brisket', cost: 32, hungerBonus: 65, happinessBonus: 13 }
            ]},
            'soup_kitchen': { name: 'Soup\'s On!', category: 'Soupes', menu: [
                { id: 'tomato_soup', name: 'Soupe Tomate & Basilic', cost: 11, hungerBonus: 35, happinessBonus: 4 },
                { id: 'onion_soup', name: 'Soupe √† l\'Oignon Gratin√©e', cost: 14, hungerBonus: 45, happinessBonus: 7 }
            ]},
            'kebab_king': { name: 'Kebab King', category: 'Kebab', menu: [
                { id: 'kebab_classic', name: 'Kebab Complet', cost: 15, hungerBonus: 80, happinessBonus: 3 },
                { id: 'kebab_plate', name: 'Assiette Kebab', cost: 19, hungerBonus: 85, happinessBonus: 4 }
            ]},
            'mamma_mia': { name: 'Mamma Mia Trattoria', category: 'Italien', menu: [
                { id: 'lasagna', name: 'Lasagne Bolognaise', cost: 25, hungerBonus: 70, happinessBonus: 10 },
                { id: 'risotto', name: 'Risotto aux Champignons', cost: 28, hungerBonus: 60, happinessBonus: 12 }
            ]},
            'daily_grind': { name: 'The Daily Grind', category: 'Caf√©', menu: [
                { id: 'cappuccino', name: 'Cappuccino', cost: 6, hungerBonus: 5, happinessBonus: 4 },
                { id: 'croissant', name: 'Croissant au Beurre', cost: 5, hungerBonus: 15, happinessBonus: 3 }
            ]},
            'tandoori_flames': { name: 'Tandoori Flames', category: 'Indien', menu: [
                { id: 'tandoori_chicken', name: 'Poulet Tandoori', cost: 25, hungerBonus: 60, happinessBonus: 10 },
                { id: 'naan', name: 'Pain Naan √† l\'Ail', cost: 5, hungerBonus: 10, happinessBonus: 2 }
            ]},
            'el_dorado': { name: 'El Dorado Steakhouse', category: 'Steakhouse', menu: [
                { id: 'filet_mignon', name: 'Filet Mignon', cost: 65, hungerBonus: 65, happinessBonus: 20 },
                { id: 'surf_turf', name: 'Surf & Turf', cost: 80, hungerBonus: 75, happinessBonus: 22 }
            ]},
            'ocean_basket': { name: 'Ocean Basket', category: 'Fruits de mer', menu: [
                { id: 'grilled_calamari', name: 'Calamars Grill√©s', cost: 26, hungerBonus: 45, happinessBonus: 9 },
                { id: 'seafood_platter', name: 'Plateau de Fruits de Mer', cost: 55, hungerBonus: 60, happinessBonus: 16 }
            ]},
            'noodle_bar': { name: 'Noodle Bar', category: 'Asiatique', menu: [
                { id: 'dan_dan_noodles', name: 'Nouilles Dan Dan', cost: 20, hungerBonus: 60, happinessBonus: 8 },
                { id: 'laksa', name: 'Soupe Laksa', cost: 23, hungerBonus: 65, happinessBonus: 11 }
            ]},
            'falafel_corner': { name: 'Falafel Corner', category: 'Moyen-Orient', menu: [
                { id: 'falafel_wrap', name: 'Wrap Falafel', cost: 14, hungerBonus: 50, happinessBonus: 5 },
                { id: 'hummus_plate', name: 'Assiette Hummus', cost: 17, hungerBonus: 40, happinessBonus: 6 }
            ]},
            'tapas_bar': { name: 'La Bodega', category: 'Tapas', menu: [
                { id: 'patatas_bravas', name: 'Patatas Bravas', cost: 10, hungerBonus: 25, happinessBonus: 7 },
                { id: 'gambas_al_ajillo', name: 'Gambas √† l\'Ail', cost: 15, hungerBonus: 30, happinessBonus: 9 }
            ]},
            'pie_shop': { name: 'The Pie Tin', category: 'Tourtes', menu: [
                { id: 'meat_pie', name: 'Tourte √† la Viande', cost: 19, hungerBonus: 65, happinessBonus: 8 },
                { id: 'apple_pie', name: 'Part de Tarte aux Pommes', cost: 9, hungerBonus: 25, happinessBonus: 10 }
            ]},
            'cheese_shop': { name: 'The Grater Good', category: 'Fromagerie', menu: [
                { id: 'cheese_platter', name: 'Planche de Fromages', cost: 32, hungerBonus: 35, happinessBonus: 14 },
                { id: 'fondue', name: 'Fondue pour un', cost: 29, hungerBonus: 50, happinessBonus: 12 }
            ]},
            'hotdog_stand': { name: 'Top Dog', category: 'Fast-Food', menu: [
                { id: 'chili_dog', name: 'Chili Hot Dog', cost: 11, hungerBonus: 45, happinessBonus: 4 },
                { id: 'classic_dog', name: 'Hot Dog Classique', cost: 8, hungerBonus: 40, happinessBonus: 2 }
            ]}
        };

        const objectivesData = {
            'career': {
                name: 'Carri√®re',
                objectives: [
                    { id: 'get_job', text: 'Obtenir son premier emploi', condition: (gs) => gs.job !== null, reward: { money: 500, reputation: 2 }, rewardText: "+500$, +2 R√©p." },
                    { id: 'get_promotion', text: 'Obtenir une promotion', condition: (gs) => gs.job && gs.job.levelIndex > 0, reward: { money: 1000, reputation: 5 }, rewardText: "+1 000$, +5 R√©p." },
                    { id: 'reach_top_career', text: 'Atteindre le sommet d\'une carri√®re', condition: (gs) => gs.job && gs.job.levelIndex === jobsData[gs.job.trackId].levels.length - 1, reward: { money: 10000, reputation: 15 }, rewardText: "+10 000$, +15 R√©p." },
                ]
            },
            'wealth': {
                name: 'Richesse',
                objectives: [
                    { id: 'reach_10k', text: 'Atteindre 10 000 $', condition: (gs) => gs.money >= 10000, reward: { money: 1000 }, rewardText: "+1 000$" },
                    { id: 'buy_property', text: 'Acheter sa premi√®re propri√©t√©', condition: (gs) => gs.ownedBusinesses.length > 0, reward: { money: 2000, reputation: 5 }, rewardText: "+2 000$, +5 R√©p." },
                    { id: 'become_millionaire', text: 'Devenir millionnaire', condition: (gs) => calculateNetWorth(gs.money, gs.ownedBusinesses) >= 1000000, reward: { money: 50000, reputation: 20 }, rewardText: "+50 000$, +20 R√©p." },
                    { id: 'buy_car', text: 'Acheter sa premi√®re voiture', condition: (gs) => gs.player.vehicle !== null, reward: { money: 1500 }, rewardText: "+1 500$" },
                ]
            },
            'social': {
                name: 'Vie Sociale',
                objectives: [
                    { id: 'get_married', text: 'Se marier', condition: (gs) => gs.player.partner && gs.player.partner.isMarried, reward: { happiness: 50, reputation: 10 }, rewardText: "+50 Bonheur, +10 R√©p." },
                    { id: 'best_friend', text: 'Devenir meilleur ami avec Alex', condition: (gs) => gs.player.relationships.friend.relationship >= 90, reward: { happiness: 20 }, rewardText: "+20 Bonheur" },
                    { id: 'high_reputation', text: 'Atteindre une r√©putation de 90', condition: (gs) => gs.player.reputation >= 90, reward: { money: 5000, reputation: 10 }, rewardText: "+5 000$, +10 R√©p." },
                ]
            },
            'collection': {
                name: 'Collection',
                objectives: [
                    { id: 'buy_luxury_watch', text: 'Acheter une montre de luxe', condition: (gs) => hasItem('watch'), reward: { reputation: 3 }, rewardText: "+3 R√©p." },
                    { id: 'buy_sports_car', text: 'Acheter une voiture de sport', condition: (gs) => gs.player.vehicle && vehicleData.find(v => v.id === gs.player.vehicle.id).category === 'Sportive', reward: { reputation: 8 }, rewardText: "+8 R√©p." },
                ]
            }
        };

        const jobsData = {
            'dev': {
                name: 'Technologie',
                zone: 'office',
                levels: [
                    { id: 'dev_junior', title: 'D√©veloppeur Junior', salary: 28, requiredSkills: { intelligence: 25 }, performanceToPromote: 100 },
                    { id: 'dev_senior', title: 'D√©veloppeur Senior', salary: 45, requiredSkills: { intelligence: 50 }, performanceToPromote: 150 },
                    { id: 'dev_lead', title: 'Chef de Projet Tech', salary: 65, requiredSkills: { intelligence: 70, charisma: 40 } }
                ]
            },
            'sales': {
                name: 'Vente',
                zone: 'commercial',
                levels: [
                    { id: 'sales_clerk', title: 'Commis de magasin', salary: 17, requiredSkills: { charisma: 5 }, performanceToPromote: 80 },
                    { id: 'sales_realtor', title: 'Agent Immobilier', salary: 25, requiredSkills: { charisma: 20 }, performanceToPromote: 120 },
                    { id: 'sales_manager', title: 'Manager Commercial', salary: 38, requiredSkills: { charisma: 40, intelligence: 30 } }
                ]
            },
            'kitchen': {
                name: 'Restauration',
                zone: 'commercial',
                levels: [
                    { id: 'kitchen_plongeur', title: 'Plongeur', salary: 16.5, requiredSkills: { manual: 5 }, performanceToPromote: 80 },
                    { id: 'kitchen_cuisinier', title: 'Cuisinier', salary: 22, requiredSkills: { manual: 20 }, performanceToPromote: 120 },
                    { id: 'kitchen_chef', title: 'Chef Cuisinier', salary: 35, requiredSkills: { manual: 50, charisma: 20 } }
                ]
            },
            'health': {
                name: 'Sant√©',
                zone: 'hospital',
                levels: [
                    { id: 'health_aide', title: 'Aide-Soignant', salary: 23, requiredSkills: { intelligence: 10, charisma: 10 }, performanceToPromote: 100 },
                    { id: 'health_infirmier', title: 'Infirmier', salary: 38, requiredSkills: { intelligence: 35 }, performanceToPromote: 150 },
                    { id: 'health_medecin', title: 'M√©decin', salary: 120, requiredSkills: { intelligence: 75 } }
                ]
            },
            'craft': {
                name: 'Artisanat',
                zone: 'industrial',
                levels: [
                    { id: 'craft_apprenti', title: 'Apprenti Artisan', salary: 19, requiredSkills: { manual: 10 }, performanceToPromote: 90 },
                    { id: 'craft_artisan', title: 'Artisan Confirm√©', salary: 28, requiredSkills: { manual: 30 }, performanceToPromote: 140 },
                    { id: 'craft_maitre', title: 'Ma√Ætre Artisan', salary: 42, requiredSkills: { manual: 60, intelligence: 20 } }
                ]
            },
            'police': {
                name: 'Police',
                zone: 'police_station',
                levels: [
                    { id: 'police_cadet', title: 'Cadet de Police', salary: 30, requiredSkills: { charisma: 10, manual: 10 }, performanceToPromote: 100 },
                    { id: 'police_officer', title: 'Agent de Police', salary: 40, requiredSkills: { charisma: 25, manual: 25 }, performanceToPromote: 150 },
                    { id: 'police_sergeant', title: 'Sergent', salary: 52, requiredSkills: { charisma: 40, intelligence: 30 }, performanceToPromote: 200 },
                    { id: 'police_lieutenant', title: 'Lieutenant', salary: 60, requiredSkills: { charisma: 50, intelligence: 50 }, performanceToPromote: 250 },
                    { id: 'police_captain', title: 'Capitaine', salary: 70, requiredSkills: { charisma: 60, intelligence: 60 } },
                    { id: 'police_sheriff', title: 'Sh√©rif', salary: 85, requiredSkills: { charisma: 75, intelligence: 70 } },
                    { id: 'police_commissioner', title: 'Commissaire', salary: 100, requiredSkills: { charisma: 85, intelligence: 80 } }
                ]
            },
            'firefighter': {
                name: 'Pompier',
                zone: 'fire_station',
                levels: [
                    { id: 'fire_recruit', title: 'Recrue Pompier', salary: 28, requiredSkills: { manual: 15, charisma: 5 }, performanceToPromote: 100 },
                    { id: 'fire_fighter', title: 'Pompier', salary: 35, requiredSkills: { manual: 30 }, performanceToPromote: 150 },
                    { id: 'fire_lieutenant', title: 'Lieutenant Pompier', salary: 45, requiredSkills: { manual: 45, intelligence: 30 }, performanceToPromote: 200 },
                    { id: 'fire_captain', title: 'Capitaine Pompier', salary: 55, requiredSkills: { manual: 60, intelligence: 45 } },
                    { id: 'fire_chief', title: 'Chef de Caserne', salary: 70, requiredSkills: { manual: 70, intelligence: 60 } }
                ]
            },
            'paramedic': {
                name: 'Ambulancier',
                zone: 'hospital',
                levels: [
                    { id: 'paramedic_trainee', title: 'Ambulancier Stagiaire', salary: 22, requiredSkills: { intelligence: 15, manual: 10 }, performanceToPromote: 100 },
                    { id: 'paramedic_basic', title: 'Ambulancier', salary: 29, requiredSkills: { intelligence: 30, manual: 20 }, performanceToPromote: 150 },
                    { id: 'paramedic_advanced', title: 'Ambulancier Avanc√©', salary: 36, requiredSkills: { intelligence: 50, manual: 30 } }
                ]
            },
            'law': {
                name: 'Droit',
                zone: 'courthouse',
                levels: [
                    { id: 'law_clerk', title: 'Greffier', salary: 26, requiredSkills: { intelligence: 30 }, performanceToPromote: 120 },
                    { id: 'law_lawyer', title: 'Avocat', salary: 50, requiredSkills: { intelligence: 60, charisma: 40 }, performanceToPromote: 200 },
                    { id: 'law_judge', title: 'Juge', salary: 90, requiredSkills: { intelligence: 85, charisma: 60 } }
                ]
            },
            'politics': {
                name: 'Politique',
                zone: 'city_hall',
                levels: [
                    { id: 'politics_assistant', title: 'Assistant Municipal', salary: 25, requiredSkills: { charisma: 30, intelligence: 20 }, performanceToPromote: 150 },
                    { id: 'politics_councilor', title: 'Conseiller Municipal', salary: 45, requiredSkills: { charisma: 60, intelligence: 50 }, performanceToPromote: 250 },
                    { id: 'politics_mayor', title: 'Maire', salary: 80, requiredSkills: { charisma: 90, intelligence: 75 } }
                ]
            },
            'retail': {
                name: 'Vente au d√©tail',
                zone: 'commercial',
                levels: [
                    { id: 'retail_cashier', title: 'Caissier(e)', salary: 16.5, requiredSkills: { manual: 5, charisma: 5 }, performanceToPromote: 100 },
                    { id: 'retail_supervisor', title: 'Superviseur de Rayon', salary: 21, requiredSkills: { manual: 15, charisma: 15 }, performanceToPromote: 150 },
                    { id: 'retail_manager', title: 'G√©rant de Magasin', salary: 28, requiredSkills: { intelligence: 30, charisma: 30 } }
                ]
            },
            'logistics': {
                name: 'Logistique',
                zone: 'industrial',
                levels: [
                    { id: 'logistics_worker', title: 'Manutentionnaire', salary: 20, requiredSkills: { manual: 15 }, performanceToPromote: 120 },
                    { id: 'logistics_coordinator', title: 'Coordinateur Logistique', salary: 26, requiredSkills: { manual: 25, intelligence: 20 }, performanceToPromote: 180 },
                    { id: 'logistics_manager', title: 'Responsable d\'Entrep√¥t', salary: 35, requiredSkills: { intelligence: 45, charisma: 30 } }
                ]
            },
            'media': {
                name: 'M√©dias',
                zone: 'office',
                levels: [
                    { id: 'media_intern', title: 'Stagiaire M√©dia', salary: 16.5, requiredSkills: { intelligence: 10, charisma: 10 }, performanceToPromote: 100 },
                    { id: 'media_journalist', title: 'Journaliste', salary: 29, requiredSkills: { intelligence: 40, charisma: 30 }, performanceToPromote: 180 },
                    { id: 'media_editor', title: 'R√©dacteur en Chef', salary: 48, requiredSkills: { intelligence: 70, charisma: 50 } }
                ]
            },
            'service': {
                name: 'Service',
                zone: 'commercial',
                levels: [
                    { id: 'service_barista', title: 'Barista', salary: 17, requiredSkills: { manual: 10, charisma: 10 }, performanceToPromote: 100 },
                    { id: 'service_waiter', title: 'Serveur(se)', salary: 16.5, requiredSkills: { manual: 5, charisma: 15 }, performanceToPromote: 110 },
                    { id: 'service_bartender', title: 'Barman', salary: 18, requiredSkills: { manual: 15, charisma: 25 } }
                ]
            }
        };

        const socialData = {
            'friend': { name: 'Alex (Ami)', relationship: 60 },
            'family': { name: 'Famille', relationship: 50 }
        };

        const vehicleData = [
            { id: 'sedan1', name: 'Kyo Piko', brand: 'Kyo', category: 'Citadine', cost: 22000, happinessBonus: 2 },
            { id: 'sedan2', name: 'Totota Yaris', brand: 'Totota', category: 'Citadine', cost: 24000, happinessBonus: 2.5 },
            { id: 'sedan3', name: 'Kyo Rio', brand: 'Kyo', category: 'Citadine', cost: 25000, happinessBonus: 2.8 },
            { id: 'sedan4', name: 'Totota Corolla', brand: 'Totota', category: 'Citadine', cost: 28000, happinessBonus: 3 },
            { id: 'sedan5', name: 'Hondo Civic', brand: 'Hondo', category: 'Citadine', cost: 30000, happinessBonus: 3.2 },
            { id: 'sedan6', name: 'Volks Jetta', brand: 'Volks', category: 'Citadine', cost: 29000, happinessBonus: 3 },
            { id: 'sedan7', name: 'Forz Focus', brand: 'Forz', category: 'Citadine', cost: 27000, happinessBonus: 2.9 },
            { id: 'sedan8', name: 'Mazdo 3', brand: 'Mazdo', category: 'Citadine', cost: 26000, happinessBonus: 2.8 },
            { id: 'berline1', name: 'Auzi A4', brand: 'Auzi', category: 'Berline', cost: 55000, happinessBonus: 6 },
            { id: 'berline2', name: 'BMM S√©rie 3', brand: 'BMM', category: 'Berline', cost: 58000, happinessBonus: 6.5 },
            { id: 'berline3', name: 'Merzo Classe C', brand: 'Merzo', category: 'Berline', cost: 60000, happinessBonus: 6.8 },
            { id: 'berline4', name: 'Auzi A6', brand: 'Auzi', category: 'Berline', cost: 75000, happinessBonus: 7.5 },
            { id: 'berline5', name: 'BMM S√©rie 5', brand: 'BMM', category: 'Berline', cost: 78000, happinessBonus: 7.8 },
            { id: 'berline6', name: 'Teslo Mod√®le 3', brand: 'Teslo', category: 'Berline', cost: 54000, happinessBonus: 7 },
            { id: 'berline7', name: 'Lexus ES', brand: 'Lexus', category: 'Berline', cost: 62000, happinessBonus: 7.2 },
            { id: 'berline8', name: 'Jaguar XE', brand: 'Jaguar', category: 'Berline', cost: 68000, happinessBonus: 8 },
            { id: 'suv1', name: 'Totota RAV4', brand: 'Totota', category: 'SUV', cost: 38000, happinessBonus: 5 },
            { id: 'suv2', name: 'Forz Explorer', brand: 'Forz', category: 'SUV', cost: 52000, happinessBonus: 5.5 },
            { id: 'suv3', name: 'Jipe Wrangler', brand: 'Jipe', category: 'SUV', cost: 48000, happinessBonus: 5.8 },
            { id: 'suv4', name: 'Auzi Q5', brand: 'Auzi', category: 'SUV', cost: 60000, happinessBonus: 6.5 },
            { id: 'suv5', name: 'BMM X5', brand: 'BMM', category: 'SUV', cost: 85000, happinessBonus: 7 },
            { id: 'suv6', name: 'Porshe Cayenne', brand: 'Porshe', category: 'SUV', cost: 110000, happinessBonus: 8 },
            { id: 'suv7', name: 'Range Rover Evoque', brand: 'Range Rover', category: 'SUV', cost: 70000, happinessBonus: 7.2 },
            { id: 'suv8', name: 'Volvo XC60', brand: 'Volvo', category: 'SUV', cost: 65000, happinessBonus: 6.8 },
            { id: 'sport1', name: 'Forz Mustang', brand: 'Forz', category: 'Sportive', cost: 55000, happinessBonus: 9 },
            { id: 'sport2', name: 'Porshe 911', brand: 'Porshe', category: 'Sportive', cost: 140000, happinessBonus: 12 },
            { id: 'sport3', name: 'Chevro Corvette', brand: 'Chevro', category: 'Sportive', cost: 95000, happinessBonus: 11 },
            { id: 'sport4', name: 'Fezizi 488', brand: 'Fezizi', category: 'Sportive', cost: 350000, happinessBonus: 18 },
            { id: 'sport5', name: 'Auzi R8', brand: 'Auzi', category: 'Sportive', cost: 220000, happinessBonus: 15 },
            { id: 'sport6', name: 'Nizan GT-R', brand: 'Nizan', category: 'Sportive', cost: 160000, happinessBonus: 13 },
            { id: 'sport7', name: 'Dodze Challenger', brand: 'Dodze', category: 'Sportive', cost: 65000, happinessBonus: 10 },
            { id: 'sport8', name: 'Jaguar F-Type', brand: 'Jaguar', category: 'Sportive', cost: 100000, happinessBonus: 11.5 },
            { id: 'luxe1', name: 'Merzo Classe S', brand: 'Merzo', category: 'Luxe', cost: 160000, happinessBonus: 15 },
            { id: 'luxe2', 'name': 'Benzy Continental', brand: 'Benzy', category: 'Luxe', cost: 320000, happinessBonus: 20 },
            { id: 'luxe3', 'name': 'Rolls-Royce Phantom', brand: 'Rolls-Royce', category: 'Luxe', cost: 600000, happinessBonus: 25 },
            { id: 'luxe4', 'name': 'Lambozini Aventador', brand: 'Lambozini', category: 'Luxe', cost: 650000, happinessBonus: 30 },
            { id: 'luxe5', 'name': 'Fezizi SF90', brand: 'Fezizi', category: 'Luxe', cost: 700000, happinessBonus: 32 },
            { id: 'luxe6', 'name': 'Buziti Chiron', brand: 'Buziti', category: 'Luxe', cost: 4000000, happinessBonus: 50 },
            { id: 'luxe7', 'name': 'Koenigsegg Jesko', brand: 'Koenigsegg', category: 'Luxe', cost: 4500000, happinessBonus: 55 },
            { id: 'luxe8', 'name': 'Pagazi Huayra', brand: 'Pagazi', category: 'Luxe', cost: 3500000, happinessBonus: 45 }
        ];

        const luxuryItems = [
            { id: 'watch', name: 'Montre de luxe', cost: 8000, bonus: { type: 'skill', skill: 'charisma', value: 2 } },
            { id: 'computer', name: 'Ordinateur surpuissant', cost: 4000, bonus: { type: 'skill_gain', skill: 'intelligence', multiplier: 1.2 } }
        ];

        const lifeEvents = [
            {
                id: 'friend_birthday',
                trigger: () => Math.random() < 0.1,
                title: "Anniversaire d'Alex",
                description: "C'est l'anniversaire de votre ami Alex ! Que faites-vous ?",
                choices: [
                    { text: "Organiser une super f√™te (200$)", condition: () => gameState.money >= 200, action: () => { removeMoney(200, "F√™te d'anniversaire"); gameState.player.relationships.friend.relationship += 20; gameState.needs.happiness += 25; showNotification("La f√™te √©tait incroyable !", 'success'); } },
                    { text: "Lui envoyer un message", condition: () => true, action: () => { gameState.player.relationships.friend.relationship += 5; gameState.needs.happiness += 5; showNotification("Alex a appr√©ci√© le geste.", 'info'); } },
                    { text: "Oublier...", condition: () => true, action: () => { gameState.player.relationships.friend.relationship -= 10; gameState.needs.happiness -= 10; showNotification("Alex est un peu d√©√ßu...", 'error'); } }
                ]
            },
            {
                id: 'family_problem',
                trigger: () => Math.random() < 0.08,
                title: "Probl√®me Familial",
                description: "Un membre de votre famille a un probl√®me financier et vous demande de l'aide.",
                choices: [
                    { text: "Envoyer 1000$", condition: () => gameState.money >= 1000, action: () => { removeMoney(1000, "Aide familiale"); gameState.player.relationships.family.relationship += 25; gameState.needs.happiness += 15; } },
                    { text: "Envoyer 250$", condition: () => gameState.money >= 250, action: () => { removeMoney(250, "Aide familiale"); gameState.player.relationships.family.relationship += 10; gameState.needs.happiness += 5; } },
                    { text: "Expliquer que vous ne pouvez pas", condition: () => true, action: () => { gameState.player.relationships.family.relationship -= 5; gameState.needs.happiness -= 5; } }
                ]
            },
            {
                id: 'meet_someone',
                trigger: () => !gameState.player.relationships.partner && Math.random() < 0.1,
                title: "Nouvelle Rencontre",
                description: "Vous avez rencontr√© quelqu'un d'int√©ressant. Que faites-vous ?",
                choices: [
                    { text: "Proposer un rendez-vous (50$)", condition: () => gameState.money >= 50, action: () => { removeMoney(50, "Rendez-vous"); gameState.player.relationships.partner = { name: 'Partenaire', relationship: 20 }; showNotification("Le rendez-vous s'est bien pass√© !", 'success'); } },
                    { text: "Rester discret", condition: () => true, action: () => { showNotification("Peut-√™tre une autre fois.", 'info'); } }
                ]
            }
            ,
            {
                id: 'get_sick',
                trigger: () => !gameState.player.sickness && gameState.needs.energy < 20 && Math.random() < 0.1,
                title: "Vous ne vous sentez pas bien",
                description: "Vous avez attrap√© un mauvais rhume. Vous vous sentez faible et fatigu√©.",
                choices: [
                    { text: "Oh non...", condition: () => true, action: () => { gameState.player.sickness = { name: 'Rhume', severity: 1 }; gameState.needs.happiness -= 20; showNotification("Vous √™tes malade. Pensez √† aller voir un m√©decin.", 'error'); } }
                ]
            },
            {
                id: 'lottery_win',
                trigger: () => Math.random() < 0.01,
                title: "Vous avez gagn√© √† la loterie !",
                description: "Votre ticket est gagnant ! Vous remportez une somme coquette.",
                choices: [
                    { text: "Incroyable !", condition: () => true, action: () => { const winnings = 5000 + Math.floor(Math.random() * 15000); addMoney(winnings, "Gain √† la loterie"); gameState.needs.happiness = 100; showNotification(`Vous avez gagn√© ${winnings.toLocaleString()}$ !`, 'success'); } }
                ]
            },
            {
                id: 'inheritance',
                trigger: () => Math.random() < 0.02,
                title: "Petit h√©ritage",
                description: "Vous recevez une lettre vous informant qu'un parent √©loign√© vous a laiss√© un petit h√©ritage.",
                choices: [
                    { text: "Quelle surprise.", condition: () => true, action: () => { const amount = 2000 + Math.floor(Math.random() * 8000); addMoney(amount, "H√©ritage"); gameState.needs.happiness += 20; showNotification(`Vous avez h√©rit√© de ${amount.toLocaleString()}$ !`, 'success'); } }
                ]
            },
            {
                id: 'car_accident',
                trigger: () => gameState.player.vehicle && Math.random() < 0.05,
                title: "Accident de voiture mineur",
                description: "Vous avez eu un petit accrochage. Personne n'est bless√©, mais il y a des r√©parations √† faire.",
                choices: [
                    { text: "Payer les r√©parations (1200$)", condition: () => gameState.money >= 1200, action: () => { removeMoney(1200, "R√©paration voiture"); gameState.needs.happiness -= 30; showNotification("Votre voiture est comme neuve, mais votre portefeuille est plus l√©ger.", 'error'); } },
                    { text: "Ignorer pour l'instant", condition: () => true, action: () => { gameState.needs.happiness -= 15; showNotification("Vous roulerez avec une voiture caboss√©e pour le moment.", 'info'); } }
                ]
            },
            {
                id: 'pickpocket',
                trigger: () => gameState.money > 100 && Math.random() < 0.04,
                title: "Vol √† la tire",
                description: "Dans un moment d'inattention, un pickpocket vous a d√©rob√© une partie de votre argent.",
                choices: [
                    { text: "Mince !", condition: () => true, action: () => { const lostAmount = Math.min(gameState.money, 50 + Math.floor(Math.random() * 150)); removeMoney(lostAmount, "Vol √† la tire"); gameState.needs.happiness -= 25; showNotification(`Vous avez perdu ${lostAmount.toLocaleString()}$ !`, 'error'); } }
                ]
            }
        ];

        const randomEvents = [
            { name: "Boom Immobilier", description: "Les prix de l'immobilier et les loyers grimpent en fl√®che !", effect: () => applyMarketChange(1.2, 1.2, 1.0) },
            { name: "Crise √âconomique", description: "Une r√©cession frappe la ville, les revenus des entreprises chutent.", effect: () => applyMarketChange(0.85, 1.0, 0.7) },
            { name: "P√©riode Faste", description: "L'√©conomie est florissante, les entreprises rapportent plus !", effect: () => applyMarketChange(1.0, 1.0, 1.3) },
        ];

        const newsItems = [
            { text: "M√©t√©o : Soleil et temp√©ratures douces attendues." },
            { text: "Les 'Cublic Strikers' ont remport√© leur dernier match 3-0." },
            { text: "Le maire annonce un plan de d√©veloppement pour la zone industrielle." },
            { text: "Potin : Une c√©l√©brit√© aper√ßue au restaurant 'Le Gourmet'." },
            { text: "Bourse : L'action TechCorp (TECH) est en forte hausse.", stockEffect: { symbol: 'TECH', impact: 1.1 } },
            { text: "Culture : Le mus√©e d'art moderne inaugure une nouvelle exposition." },
            { text: "Alerte canicule : restez hydrat√©s !" },
            { text: "Des averses sont pr√©vues pour demain apr√®s-midi." },
            { text: "Le Cublic FC recrute un nouvel attaquant vedette." },
            { text: "La saison de basketball commence la semaine prochaine." },
            { text: "Le prix de l'immobilier continue de grimper en ville.", stockEffect: { symbol: 'REAL', impact: 1.05 } },
            { text: "La startup locale 'Innovatech' l√®ve 10 millions de dollars.", stockEffect: { symbol: 'TECH', impact: 1.08 } },
            { text: "Le taux de ch√¥mage est au plus bas depuis 5 ans." },
            { text: "D√©bat houleux √† la mairie concernant le nouveau parc." },
            { text: "Les √©lections municipales approchent √† grands pas." },
            { text: "Un festival de musique gratuit aura lieu au Parc Central ce week-end." },
            { text: "Rumeur : l'acteur Jean Dupont aurait achet√© un penthouse en ville." },
            { text: "Le film 'La Tour Sombre' bat des records au box-office." },
            { text: "L'universit√© locale annonce une perc√©e dans la recherche sur l'IA.", stockEffect: { symbol: 'TECH', impact: 1.15 } },
            { text: "Un nouveau smartphone r√©volutionnaire attendu pour le mois prochain." },
            { text: "Un chat a √©t√© √©lu 'plus bel animal de la ville'." },
            { text: "Concours de la plus grosse citrouille : les inscriptions sont ouvertes." },
            { text: "Le trafic est dense sur l'autoroute principale." },
            { text: "Une nouvelle piste cyclable sera construite le long de la rivi√®re." },
            { text: "Le prix du caf√© a augment√© de 5% ce mois-ci.", stockEffect: { symbol: 'FOOD', impact: 1.02 } },
            { text: "Analyse : les actions du secteur de l'√©nergie (NRG) sont √† surveiller.", stockEffect: { symbol: 'NRG', impact: 1.05 } },
            { text: "Le zoo de la ville accueille un nouveau couple de pandas." },
            { text: "La biblioth√®que municipale prolonge ses heures d'ouverture." },
            { text: "Un c√©l√®bre chef ouvre un nouveau restaurant dans la zone commerciale." },
            { text: "La grippe saisonni√®re est en avance cette ann√©e, vaccinez-vous !" },
            { text: "La police met en garde contre une nouvelle arnaque t√©l√©phonique." },
            { text: "Le marathon de la ville aura lieu dimanche prochain." },
            { text: "Les inscriptions pour les cours du soir √† l'universit√© sont ouvertes." },
            { text: "Un artiste de rue local gagne en popularit√© sur les r√©seaux sociaux." },
            { text: "Les loyers dans le quartier r√©sidentiel ont augment√© de 3%." },
            { text: "Le groupe de rock 'Les D√©cibels' donner√† un concert surprise ce soir." },
            { text: "M√©t√©o : risque d'orages en fin de journ√©e." },
            { text: "Le cours de l'action FOOD est stable malgr√© les rumeurs de rachat.", stockEffect: { symbol: 'FOOD', impact: 0.98 } },
            { text: "Un nouveau gratte-ciel est en construction dans le quartier des affaires." },
            { text: "La ville lance une campagne de recyclage plus agressive." },
            { text: "Le festival du film ind√©pendant se tiendra le mois prochain." },
            { text: "Les experts pr√©voient un hiver doux cette ann√©e." },
            { text: "Le club de lecture local recherche de nouveaux membres." },
            { text: "Une exposition de voitures anciennes aura lieu au concessionnaire ce samedi." },
            { text: "La patinoire du Parc Central est maintenant ouverte au public." },
            { text: "Les agriculteurs locaux signalent une r√©colte exceptionnelle de pommes." },
            { text: "Le th√©√¢tre municipal pr√©sente une nouvelle pi√®ce de Moli√®re." },
            { text: "Une panne de courant a bri√®vement affect√© la zone industrielle.", stockEffect: { symbol: 'NRG', impact: 0.95 } },
            { text: "Le prix des billets de cin√©ma va augmenter le mois prochain." },
            { text: "La ville a √©t√© class√©e parmi les 10 villes les plus agr√©ables √† vivre du pays." }
        ];

        const researchData = [
            { id: 'ai_research', name: 'Recherche sur l\'IA', cost: 50000, durationDays: 30, description: 'D√©bloque la possibilit√© de cr√©er des Laboratoires d\'IA.', reward: { type: 'new_business', business: { name: 'Labo IA', cost: 100000, baseIncome: 1200 } } },
            { id: 'green_energy', name: '√ânergies renouvelables', cost: 75000, durationDays: 45, description: 'Donne un coup de pouce permanent aux actions du secteur de l\'√©nergie.', reward: { type: 'stock_boost', symbol: 'NRG', multiplier: 1.5 } },
            { id: 'urban_planning', name: 'Urbanisme Avanc√©', cost: 100000, durationDays: 60, description: 'Augmente la valeur de toutes vos propri√©t√©s immobili√®res de 10%.', reward: { type: 'property_boost', multiplier: 1.1 } }
        ];

        const buildingIcons = {
            residential: ['üè†', 'üè°'],
            commercial: ['üè¨', 'üè™'],
            office: ['üèôÔ∏è', 'üè§'],
            industrial: ['üè≠']
        };

        function generateBusinesses(type, count) {
            const businesses = [];
            let templates;

            const commercialTemplates = [
                { name: 'Pizzeria', basePrice: 150000, baseIncome: 1500, category: 'Restauration' },
                { name: 'Caf√©', basePrice: 120000, baseIncome: 1000, category: 'Restauration' },
                { name: 'Restaurant Asiatique', basePrice: 40000, baseIncome: 700, category: 'Restauration' },
                { name: 'Bar √† Cocktails', basePrice: 55000, baseIncome: 900, category: 'Divertissement' },
                { name: 'Librairie', basePrice: 30000, baseIncome: 450, category: 'Boutique' },
                { name: 'Boutique de V√™tements', basePrice: 45000, baseIncome: 650, category: 'Boutique' },
                { name: 'Cin√©ma', basePrice: 150000, baseIncome: 2500, category: 'Divertissement' },
                { name: 'Salle de Sport', basePrice: 80000, baseIncome: 1200, category: 'Service' },
                { name: 'Fleuriste', basePrice: 15000, baseIncome: 250, category: 'Boutique' },
                { name: 'Boulangerie', basePrice: 22000, baseIncome: 400, category: 'Restauration' },
                { name: 'Glacier', basePrice: 19000, baseIncome: 380, category: 'Restauration' },
                { name: 'Magasin d\'√âlectronique', basePrice: 90000, baseIncome: 1100, category: 'Boutique' },
                { name: 'Barbier', basePrice: 28000, baseIncome: 500, category: 'Service' },
                { name: 'Salon de Tatouage', basePrice: 40000, baseIncome: 750, category: 'Service' },
                { name: '√âpicerie Fine', basePrice: 35000, baseIncome: 550, category: 'Boutique' },
                { name: 'Sushi Bar', basePrice: 42000, baseIncome: 720, category: 'Restauration' },
                { name: 'Magasin de Jeux Vid√©o', basePrice: 60000, baseIncome: 800, category: 'Boutique' },
                { name: 'Animalerie', basePrice: 38000, baseIncome: 500, category: 'Boutique' },
                { name: 'Spa', basePrice: 75000, baseIncome: 1300, category: 'Service' },
                { name: 'Galerie d\'Art', basePrice: 120000, baseIncome: 1500, category: 'Divertissement' },
            ];

            const industrialTemplates = [
                { name: 'Petit Entrep√¥t', basePrice: 250000, baseIncome: 2500 },
                { name: 'Usine de Textile', basePrice: 800000, baseIncome: 8000 },
                { name: 'Atelier de M√©tallurgie', basePrice: 600000, baseIncome: 6500 },
                { name: 'Imprimerie', basePrice: 400000, baseIncome: 4000 },
                { name: 'Centre de Logistique', basePrice: 1200000, baseIncome: 12000 },
                { name: 'Menuiserie', basePrice: 300000, baseIncome: 3200 },
                { name: 'Garage de R√©paration', basePrice: 350000, baseIncome: 4500 },
                { name: 'Usine Agro-alimentaire', basePrice: 1500000, baseIncome: 15000 },
                { name: 'Brasserie Artisanale', basePrice: 450000, baseIncome: 5000 },
                { name: 'Centre de Recyclage', basePrice: 700000, baseIncome: 6000 },
                { name: 'Usine Pharmaceutique', basePrice: 2500000, baseIncome: 25000 },
            ];

            const residentialTemplates = [
                { name: 'Studio', basePrice: 250000, baseRent: 1200, description: '1 pi√®ce, 30m¬≤' },
                { name: 'Appartement T2', basePrice: 350000, baseRent: 1600, description: '2 pi√®ces, 50m¬≤' },
                { name: 'Appartement T3', basePrice: 450000, baseRent: 2100, description: '3 pi√®ces, 75m¬≤' },
                { name: 'Condo de Luxe', basePrice: 700000, baseRent: 3200, description: '4 pi√®ces, 120m¬≤, Piscine' },
                { name: 'Maison de Ville', basePrice: 850000, baseRent: 4000, description: '5 pi√®ces, 150m¬≤, Jardin' },
                { name: 'Penthouse', basePrice: 2500000, baseRent: 9000, description: '6 pi√®ces, 250m¬≤, Vue Panoramique' },
            ];

            switch (type) {
                case 'commercial': templates = commercialTemplates; break;
                case 'industrial': templates = industrialTemplates; break;
                case 'residential': templates = residentialTemplates; break;
                default: return [];
            }

            for (let i = 0; i < count; i++) {
                const template = templates[Math.floor(Math.random() * templates.length)];
                const price = template.basePrice + (Math.random() - 0.5) * (template.basePrice * 0.4);
                const income = template.baseIncome ? template.baseIncome + (Math.random() - 0.5) * (template.baseIncome * 0.4) : 0;
                const rent = template.baseRent ? template.baseRent + (Math.random() - 0.5) * (template.baseRent * 0.4) : 0;
                
                businesses.push({
                    id: `${type}${i}`,
                    name: template.name,
                    price: Math.round(price / 100) * 100,
                    income: Math.round(income / 10) * 10,
                    rent: Math.round(rent / 10) * 10,
                    category: template.category || 'Industriel',
                    availableRenovations: [],
                    isHomelessShelter: false,
                    renovationLevel: 0,
                    description: template.description || null,
                });
            }
            return businesses;
        }

        function createDefaultGameState() {
            return {
                money: 500,
                time: { day: 1, month: 1, hour: 8, minute: 0, timeSinceSleep: 0 },
                needs: { energy: 100, happiness: 80, hunger: 100, health: 100 },
                job: null,
                loan: null,
                player: { 
                    sickness: null,
                    currentLocationId: 'home',
                    rentedPropertyId: 'player_home',
                    hasChild: false,
                    vehicle: null,
                    partner: null,
                    researchProject: null,
                    completedObjectives: [],
                    homeStyle: 'default',
                    reputation: 50,
                    unlockedBusinessTypes: [],
                    relationships: JSON.parse(JSON.stringify(socialData)),
                    transactions: [],
                    portfolio: { stocks: {} },
                    skills: { charisma: 0, intelligence: 0, manual: 0 },
                    inventory: []
                },
                ownedBusinesses: [],
                competitors: [],
                world: {
                    zones: [
                        { 
                            id: 'home', 
                            name: 'Mon Appartement', 
                            icon: 'üè†', 
                            actions: []
                        },
                        { 
                            id: 'homeless', 
                            name: 'La Rue', 
                            icon: '‚õ∫', 
                            isHomelessShelter: true,
                            actions: [],
                            businesses: [{
                                id: 'player_home',
                                name: 'Studio',
                                price: 80000,
                            rent: 1200,
                                description: '1 pi√®ce, 30m¬≤'
                            }]
                        },
                        { 
                            id: 'residential_quarter', 
                            name: 'Quartier R√©sidentiel', 
                            icon: 'üèòÔ∏è', 
                            businesses: generateBusinesses('residential', 60)
                        },
                        { 
                            id: 'park1', 
                            name: 'Parc Central', 
                            icon: 'üå≥', 
                            actions: [ 
                                { label: 'Faire du sport', onComplete: () => { gameState.needs.happiness = Math.min(100, gameState.needs.happiness + 20); gameState.needs.energy = Math.max(0, gameState.needs.energy - 15); advanceTime(1); } },
                                { label: 'Faire un Pique-nique', onComplete: () => { gameState.needs.happiness = Math.min(100, gameState.needs.happiness + 25); gameState.needs.energy = Math.min(100, gameState.needs.energy + 5); advanceTime(2); } }
                            ] 
                        },
                        { 
                            id: 'park2', 
                            name: 'Jardin Public', 
                            icon: 'üå≥', 
                            actions: [ 
                                { label: 'Admirer les fleurs', onComplete: () => { gameState.needs.happiness = Math.min(100, gameState.needs.happiness + 15); advanceTime(1); } },
                                { label: 'Nourrir les canards', onComplete: () => { gameState.needs.happiness = Math.min(100, gameState.needs.happiness + 10); advanceTime(0.5); } }
                            ] 
                        },
                        { 
                            id: 'park3', 
                            name: 'Square du Quartier', 
                            icon: 'üå≥', 
                            actions: [ 
                                { label: 'Lire sur un banc', onComplete: () => { gameState.needs.happiness = Math.min(100, gameState.needs.happiness + 20); advanceTime(2); } },
                                { label: 'M√©diter', onComplete: () => { gameState.needs.happiness = Math.min(100, gameState.needs.happiness + 15); gameState.needs.energy = Math.min(100, gameState.needs.energy + 10); advanceTime(1); } }
                            ] 
                        },
                        { 
                            id: 'industrial', 
                            name: 'Zone Industrielle', 
                            icon: 'üè≠', 
                            actions: [],
                            businesses: generateBusinesses('industrial', 35)
                        },
                        { 
                            id: 'commercial', 
                            name: 'Zone Commerciale', 
                            icon: 'üõí', 
                            actions: [ { label: 'L√®che-vitrine', onComplete: () => { gameState.needs.happiness = Math.min(100, gameState.needs.happiness + 10); advanceTime(1); } } ],
                            businesses: generateBusinesses('commercial', 45)
                        },
                        {
                            id: 'university',
                            name: 'Universit√©',
                            icon: 'üéì',
                            actions: [
                                { label: '√âtudier (500$)', onComplete: () => improveSkill('intelligence', 500) },
                                { label: 'Cours de communication (500$)', onComplete: () => improveSkill('charisma', 500) },
                                { label: 'Formation manuelle (500$)', onComplete: () => improveSkill('manual', 500) },
                            ]
                        },
                        {
                            id: 'airport',
                            name: 'A√©roport',
                            icon: '‚úàÔ∏è',
                            actions: []
                        }
                        ,
                        {
                            id: 'office',
                            name: 'Quartier des Affaires',
                            icon: 'üèôÔ∏è',
                            actions: [],
                            businesses: generateBusinesses('office', 20)
                        },
                        {
                            id: 'hospital',
                            name: 'H√¥pital',
                            icon: 'üè•',
                            actions: []
                        },
                        {
                            id: 'luxury_mall',
                            name: 'Centre Commercial de Luxe',
                            icon: 'üíé',
                            actions: []
                        }
                        ,
                        {
                            id: 'car_dealership',
                            name: 'Concessionnaire Auto',
                            icon: 'üöó',
                            actions: []
                        }
                        ,
                        {
                            id: 'pawn_shop',
                            name: 'Pr√™teur sur Gages',
                            icon: 'üí∞',
                            actions: []
                        }
                        ,
                        {
                            id: 'police_station',
                            name: 'Commissariat',
                            icon: 'üöì',
                            actions: []
                        },
                        {
                            id: 'fire_station',
                            name: 'Caserne de pompiers',
                            icon: 'üöí',
                            actions: []
                        },
                        {
                            id: 'courthouse',
                            name: 'Palais de Justice',
                            icon: '‚öñÔ∏è',
                            actions: []
                        },
                        {
                            id: 'city_hall',
                            name: 'Mairie',
                            icon: 'üèõÔ∏è',
                            actions: []
                        },
                        {
                            id: 'charity_org',
                            name: 'Organisation Caritative',
                            icon: 'üíñ',
                            actions: []
                        }
                    ],
                    stocks: [
                        { symbol: 'TECH', name: 'TechCorp', price: 100, volatility: 2, history: [100] },
                        { symbol: 'NRG', name: 'Energy Inc.', price: 50, volatility: 3, history: [50] },
                        { symbol: 'REAL', name: 'Realty Global', price: 75, volatility: 1.5, history: [75] },
                        { symbol: 'FOOD', name: 'Global Foods', price: 60, volatility: 1, history: [60] }
                    ],
                },
                customBusinesses: [],
            };
        }

        function createCompetitors() {
            gameState.competitors.push({ name: 'Isabelle Moreau', money: 25000, ownedBusinesses: [] });
            gameState.competitors.push({ name: 'Marc Dubois', money: 15000, ownedBusinesses: [] });
            gameState.competitors.push({ name: 'Sofia Rossi', money: 40000, ownedBusinesses: [] });
            gameState.competitors.push({ name: 'Arthur Chen', money: 75000, ownedBusinesses: [] });
            gameState.competitors.push({ name: 'Elena Petrova', money: 5000, ownedBusinesses: [] });
            gameState.competitors.push({ name: 'David Goldstein', money: 150000, ownedBusinesses: [] });
            gameState.competitors.push({ name: 'Chlo√© Dubois', money: 20000, ownedBusinesses: [] });
            gameState.competitors.push({ name: 'Kenji Tanaka', money: 90000, ownedBusinesses: [] });
            gameState.competitors.push({ name: 'Fatima Al-Jamil', money: 60000, ownedBusinesses: [] });
            gameState.competitors.push({ name: 'Liam O\'Connell', money: 10000, ownedBusinesses: [] });

            // Give some competitors a starting business
            const startingBiz = gameState.world.zones.find(z => z.id === 'commercial').businesses[0];
            if (startingBiz && !isBusinessOwned(startingBiz.id)) {
                gameState.competitors[2].ownedBusinesses.push(startingBiz.id);
            }
        }

        function switchScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            
            if (screenId === 'game-screen' && !gameInterval) {
                gameInterval = setInterval(gameLoop, GAME_TICK_MS);
            } else if (screenId !== 'game-screen' && gameInterval) {
                clearInterval(gameInterval);
                gameInterval = null;
            }

            if (screenId === 'game-screen' && !autosaveInterval) {
                autosaveInterval = setInterval(() => {
                    if (gameState) localStorage.setItem(SAVE_KEY, JSON.stringify(gameState));
                }, 5000);
            } else if (screenId !== 'game-screen' && autosaveInterval) {
                clearInterval(autosaveInterval);
                autosaveInterval = null;
            }

            if (screenId === 'game-screen' && !playerStatusInterval) {
                playerStatusInterval = setInterval(updatePlayerStatusTicker, 10000);
            } else if (screenId !== 'game-screen' && playerStatusInterval) {
                clearInterval(playerStatusInterval);
                playerStatusInterval = null;
            }

            if (screenId === 'game-screen' && !newsTickerInterval) {
                newsTickerInterval = setInterval(updateNewsTicker, 10000);
            } else if (screenId !== 'game-screen' && newsTickerInterval) {
                clearInterval(newsTickerInterval);
            }
        }

        function startGame(state) {
            if (!state.competitors) {
                state.competitors = [];
            }
            if (!state.customBusinesses) {
                state.customBusinesses = [];
            } else {
                state.customBusinesses.forEach(biz => {
                    if (!biz.hasOwnProperty('equipmentLevel')) biz.equipmentLevel = 0;
                    if (!biz.hasOwnProperty('trainingLevel')) biz.trainingLevel = 0;
                });
            }
            if (state.player) {
                if (!state.player.hasOwnProperty('hasChild')) state.player.hasChild = false;
                if (!state.player.hasOwnProperty('partner')) state.player.partner = null;
                if (!state.player.hasOwnProperty('vehicle')) state.player.vehicle = null;
                if (!state.player.hasOwnProperty('completedObjectives')) state.player.completedObjectives = [];
                if (!state.player.hasOwnProperty('homeStyle')) state.player.homeStyle = 'default';
                if (!state.player.hasOwnProperty('reputation')) state.player.reputation = 50;
                if (!state.player.hasOwnProperty('sickness')) state.player.sickness = null;
                if (!state.player.hasOwnProperty('researchProject')) state.player.researchProject = null;
                if (!state.player.hasOwnProperty('unlockedBusinessTypes')) state.player.unlockedBusinessTypes = [];
            }
            if (state.player && state.player.inventory) {
                if (typeof state.player.vehicle === 'string') state.player.vehicle = { id: state.player.vehicle, color: 'Gris' };
            }
            if (state.world && state.world.zones && !state.world.zones.some(z => z.id === 'car_dealership')) {
                const defaultState = createDefaultGameState();
                state.world.zones.push(defaultState.world.zones.find(z => z.id === 'car_dealership'));
            }
            if (state.world && state.world.zones && !state.world.zones.some(z => z.id === 'pawn_shop')) {
                const defaultState = createDefaultGameState();
                state.world.zones.push(defaultState.world.zones.find(z => z.id === 'pawn_shop'));
            }
            if (state.world && state.world.zones && !state.world.zones.some(z => z.id === 'police_station')) {
                const defaultState = createDefaultGameState();
                state.world.zones.push(defaultState.world.zones.find(z => z.id === 'police_station'));
            }
            if (state.world && state.world.zones && !state.world.zones.some(z => z.id === 'fire_station')) {
                const defaultState = createDefaultGameState();
                state.world.zones.push(defaultState.world.zones.find(z => z.id === 'fire_station'));
            }
            if (state.world && state.world.zones && !state.world.zones.some(z => z.id === 'courthouse')) {
                const defaultState = createDefaultGameState();
                state.world.zones.push(defaultState.world.zones.find(z => z.id === 'courthouse'));
            }
            if (state.world && state.world.zones && !state.world.zones.some(z => z.id === 'city_hall')) {
                const defaultState = createDefaultGameState();
                state.world.zones.push(defaultState.world.zones.find(z => z.id === 'city_hall'));
            }
            if (state.world && state.world.zones && !state.world.zones.some(z => z.id === 'charity_org')) {
                const defaultState = createDefaultGameState();
                state.world.zones.push(defaultState.world.zones.find(z => z.id === 'charity_org'));
            }
            if (state.world && state.world.zones) {
                state.world.zones.forEach(zone => {
                    if (zone.businesses) {
                        zone.businesses.forEach(business => {
                            if (!business.hasOwnProperty('renovationLevel')) business.renovationLevel = 0;
                            if (!business.hasOwnProperty('availableRenovations')) business.availableRenovations = [];
                        });
                    }
                });
            }
            if (!state.needs.hasOwnProperty('health')) {
                state.needs.health = 100;
            }

            gameState = state;
            if (gameState.competitors.length === 0) createCompetitors();
            renderUI();
            updateActionButtons();
            switchScreen('game-screen');
        }

        document.getElementById('new-game-btn').addEventListener('click', () => {
            startGame(createDefaultGameState());
        });

        document.getElementById('continue-btn').addEventListener('click', () => {
            const savedState = localStorage.getItem(SAVE_KEY);
            if (savedState) {
                try {
                    startGame(JSON.parse(savedState));
                } catch (e) {
                    console.error("Failed to parse save file, starting new game.", e);
                    alert("Votre sauvegarde est corrompue. Une nouvelle partie va commencer.");
                    startGame(createDefaultGameState());
                }
            } else {
                alert("Aucune partie sauvegard√©e trouv√©e.");
            }
        });

        document.getElementById('close-options-btn').addEventListener('click', () => {
            document.getElementById('options-modal').classList.remove('active');
        });

        document.getElementById('reset-game-btn').addEventListener('click', () => {
            if (confirm("√ätes-vous s√ªr de vouloir r√©initialiser votre partie ? Toute votre progression sera perdue.")) {
                localStorage.removeItem(SAVE_KEY);
                window.location.reload();
            }
        });

        document.getElementById('options-btn').addEventListener('click', () => {
            document.getElementById('options-modal').classList.add('active');
        });

        function setupNewsTicker() {
            const tickerContent = document.getElementById('news-ticker-content');
            shuffledNews = newsItems.sort(() => 0.5 - Math.random());
            currentNewsIndex = 0;
            if (shuffledNews.length > 0) {
                tickerContent.textContent = shuffledNews[currentNewsIndex].text;
            }
        }

        function updateNewsTicker() {
            const tickerContent = document.getElementById('news-ticker-content');
            tickerContent.style.opacity = 0;

            setTimeout(() => {
                currentNewsIndex++;
                if (currentNewsIndex >= shuffledNews.length) {
                    currentNewsIndex = 0;
                }
                const currentNews = shuffledNews[currentNewsIndex];
                tickerContent.textContent = currentNews.text;
                tickerContent.style.opacity = 1;

                if (currentNews.stockEffect) {
                    const stock = gameState.world.stocks.find(s => s.symbol === currentNews.stockEffect.symbol);
                    if (stock) {
                        stock.price *= currentNews.stockEffect.impact;
                        showNotification(`Impact sur la bourse: ${stock.name} (${stock.symbol}) est affect√© par l'actualit√©.`, 'info');
                    }
                }
            }, 500);
        }

        function updatePlayerStatusTicker() {
            const statusContent = document.getElementById('player-status-content');
            const messages = {
                hungry: ["J'ai vraiment faim...", "Mon estomac gargouille.", "Je pourrais manger n'importe quoi."],
                tired: ["Je suis √©puis√©(e)...", "Mes paupi√®res sont lourdes.", "Je pourrais m'endormir debout."],
                unhappy: ["Je me sens un peu d√©moralis√©(e).", "Rien ne va comme je veux...", "Quelle journ√©e..."],
                lonely: ["Je me sens un peu seul(e) en ce moment.", "√áa fait longtemps que je n'ai pas vu mes amis.", "Un appel √† un proche me ferait du bien."],
                fine: ["Tout va bien pour le moment.", "Je me sens bien.", "Une belle journ√©e en perspective."]
            };

            if (!gameState) return;

            let currentStatus = messages.fine[Math.floor(Math.random() * messages.fine.length)];

            if (gameState.needs.hunger < 30) {
                currentStatus = messages.hungry[Math.floor(Math.random() * messages.hungry.length)];
            } else if (gameState.needs.energy < 30) {
                currentStatus = messages.tired[Math.floor(Math.random() * messages.tired.length)];
            } else if (gameState.needs.happiness < 30) {
                currentStatus = messages.unhappy[Math.floor(Math.random() * messages.unhappy.length)];
            } else if (gameState.player.relationships.friend.relationship < 20 && gameState.time.day > 2) {
                currentStatus = messages.lonely[Math.floor(Math.random() * messages.lonely.length)];
            }

            statusContent.textContent = currentStatus;
        }





        function renderUI() {
            if (!gameState) return;

            document.querySelector('#header #money-display').textContent = `${Math.floor(gameState.money)} $`;
            const hour = Math.floor(gameState.time.hour).toString().padStart(2, '0');
            const minute = Math.floor(gameState.time.minute).toString().padStart(2, '0');
            document.querySelector('#header #time-display').textContent = `Jour ${gameState.time.day} - ${hour}:${minute}`;
        }

        function gameLoop() {
            if (!gameState) return;

            const timeSpeed = 1 * (GAME_TICK_MS / 1000);
            gameState.time.minute += timeSpeed;
            if (gameState.time.minute >= 60) {
                gameState.time.minute = 0;
                gameState.time.hour++;
                gameState.time.timeSinceSleep++;
            }
            if (gameState.time.hour >= 24) {
                gameState.time.hour = 0;
                collectDailyIncome();
                gameState.time.day++;

                if (gameState.player.researchProject) {
                    gameState.player.researchProject.daysRemaining--;
                    if (gameState.player.researchProject.daysRemaining <= 0) {
                        completeResearch(gameState.player.researchProject.projectId);
                    }
                }

                if (gameState.time.day > 30) {
                    gameState.time.day = 1;
                    gameState.time.month++;

                    if (gameState.job) {
                        let fireChance = 0;
                        if (gameState.job.performance < 20) fireChance += 10;
                        if (gameState.needs.happiness < 10) fireChance += 15;
                        if (Math.random() * 100 < fireChance) {
                            showNotification(`Vous avez √©t√© licenci√© pour manque de performance !`, 'error');
                            gameState.job = null;
                        }
                    }

                    lifeEvents.forEach(event => {
                        if (event.trigger()) {
                            clearInterval(gameInterval);
                            showLifeEvent(event);
                        }
                    });

                    if (gameState.player.partner && gameState.player.partner.relationship > 90 && !gameState.player.partner.isMarried && Math.random() < 0.2) {
                        clearInterval(gameInterval);
                        showLifeEvent({
                            id: 'proposal', title: "Demande en Mariage", description: "Votre relation est au beau fixe. Voulez-vous demander votre partenaire en mariage ?",
                            choices: [
                                { text: "Faire la grande demande", condition: () => true, action: () => { gameState.player.partner.isMarried = true; gameState.needs.happiness = 100; showNotification("F√©licitations pour votre mariage !", 'success'); } },
                                { text: "Attendre encore un peu", condition: () => true, action: () => { gameState.player.partner.relationship -= 5; } }
                            ]
                        });
                    }
                    if (gameState.player.partner && gameState.player.partner.isMarried && !gameState.player.hasChild && Math.random() < 0.15) {
                        clearInterval(gameInterval);
                        showLifeEvent({
                            id: 'have_child', title: "Agrandir la famille ?", description: "Vous et votre partenaire avez discut√© d'avoir un enfant. √ätes-vous pr√™t ?",
                            choices: [
                                { text: "Oui, c'est le moment parfait !", condition: () => true, action: () => { gameState.player.hasChild = true; gameState.needs.happiness = 100; showNotification("F√©licitations pour la naissance de votre enfant !", 'success'); } },
                                { text: "Pas tout de suite.", condition: () => true, action: () => { gameState.player.partner.relationship -= 10; } }
                            ]
                        });
                    }
                    if (gameState.player.hasChild && findBusinessById(gameState.player.rentedPropertyId).name === 'Studio') {
                        clearInterval(gameInterval);
                        const biggerHome = gameState.world.zones.find(z => z.id === 'residential_quarter').businesses.find(b => b.name === 'Appartement T3');
                        if (biggerHome) {
                            showLifeEvent({
                                id: 'move_home', title: "Besoin de plus d'espace", description: "Votre studio est un peu petit pour une famille. Voulez-vous d√©m√©nager dans un appartement plus grand ?",
                                choices: [
                                    { text: `D√©m√©nager (Loyer: ${biggerHome.rent}$/m)`, condition: () => gameState.money >= biggerHome.rent, action: () => { window.rentProperty(biggerHome.id); } },
                                    { text: "Rester pour l'instant", condition: () => true, action: () => {} }
                                ]
                            });
                        }
                    }


                    processMonthlyBills();
                    if (Math.random() < 0.33) {
                        const event = randomEvents[Math.floor(Math.random() * randomEvents.length)];
                        event.effect();
                        showNotification(`√âv√©nement: ${event.description}`, 'info');
                    }
                }
            }

            // Business logic
            const allOwnedBusinesses = [...gameState.ownedBusinesses.map(id => findBusinessById(id)), ...gameState.customBusinesses];
            allOwnedBusinesses.forEach(biz => {
                if (biz.stock !== undefined) {
                    if (biz.stock > 0) {
                        biz.stock -= (biz.employees > 0 ? biz.employees : 1) * 0.1; // Stock consumption
                    } else {
                        biz.stock = 0;
                    }
                }
            });

            checkObjectives();

            let energyDecay = 0.005;
            if (gameState.needs.hunger < 20) energyDecay += 0.01; 
            if (gameState.time.timeSinceSleep > 20) energyDecay += 0.02; 
            gameState.needs.energy = Math.max(0, gameState.needs.energy - energyDecay);
            gameState.needs.hunger = Math.max(0, gameState.needs.hunger - 0.05);
            let happinessDecay = 0.01;
            if (gameState.needs.hunger < 10) happinessDecay += 0.01;
            if (gameState.needs.energy < 10) happinessDecay += 0.01;

            let reputationChange = 0;
            if (gameState.needs.happiness < 20) reputationChange -= 0.01;
            if (!gameState.player.rentedPropertyId) reputationChange -= 0.02; // Homeless
            if (gameState.money < 0) reputationChange -= 0.01;
            if (gameState.money > 1000000) reputationChange += 0.005;

            gameState.player.reputation = Math.max(0, Math.min(100, gameState.player.reputation + reputationChange));

            if (gameState.player.sickness) {
                const severity = gameState.player.sickness.severity;
                energyDecay += 0.02 * severity;
                happinessDecay += 0.02 * severity;
                gameState.needs.health = Math.max(0, gameState.needs.health - (0.01 * severity));

                if (gameState.needs.health <= 0) {
                    removeMoney(500, "Urgence m√©dicale");
                    gameState.needs.health = 50;
                    gameState.player.sickness = null;
                    showNotification("Vous vous √™tes √©vanoui ! Vous vous r√©veillez √† l'h√¥pital avec une facture de 500$.", 'error');
                }
            }
            if (gameState.player.vehicle) {
                const vehicle = vehicleData.find(v => v.id === gameState.player.vehicle.id);
                gameState.needs.happiness = Math.min(100, gameState.needs.happiness + vehicle.happinessBonus * 0.001);
            }

            gameState.customBusinesses.forEach(biz => {
                if (biz.marketingBoost && biz.marketingBoost.duration > 0) {
                    biz.marketingBoost.duration--;
                    if (biz.marketingBoost.duration === 0) biz.marketingBoost = null;
                }
            });

            Object.values(gameState.player.relationships).forEach(rel => {
                rel.relationship = Math.max(0, rel.relationship - 0.02);
                if (rel.relationship < 20) happinessDecay += 0.005;
            });
            gameState.needs.happiness = Math.max(0, gameState.needs.happiness - happinessDecay);
            renderUI();

            if (Math.random() < 0.1) {
                gameState.world.stocks.forEach(stock => {
                    const change = (Math.random() - 0.49) * stock.volatility;
                    stock.price = Math.max(1, stock.price + change);
                    stock.history.push(stock.price);
                    if (stock.history.length > 50) stock.history.shift();
                });
            }

            gameState.competitors.forEach(competitor => {
                if (competitor.money > 20000 && Math.random() < 0.05) {
                    const availableBusinesses = [];
                    gameState.world.zones.forEach(zone => {
                        if (zone.businesses) availableBusinesses.push(...zone.businesses);
                    });
                    const affordableBusinesses = availableBusinesses.filter(b => b.price < competitor.money && !isBusinessOwned(b.id));
                    if (affordableBusinesses.length > 0) {
                        const target = affordableBusinesses[Math.floor(Math.random() * affordableBusinesses.length)];
                        competitor.money -= target.price;
                        competitor.ownedBusinesses.push(target.id);
                    }
                }
            });

            renderUI();
        }

        function collectDailyIncome() {
            if (!gameState || gameState.ownedBusinesses.length === 0) return;

            let totalIncome = 0;
            gameState.ownedBusinesses.forEach(businessId => {
                const business = findBusinessById(businessId);
                if (business && business.income > 0) {
                    const isOutOfStock = business.stock !== undefined && business.stock <= 0;
                    if (!isOutOfStock) {
                        totalIncome += getCustomBusinessIncome(business);
                    }
                }
            });

            if (totalIncome > 0) {
                addMoney(totalIncome, "Revenus quotidiens des entreprises");
                showNotification(`Revenus quotidiens: +${totalIncome.toLocaleString()}$`, 'success');
            }
        }

        function processMonthlyBills() {
            const taxRate = 0.20;
            let totalIncome = 0;
            let totalRentIncome = 0;

            gameState.ownedBusinesses.forEach(businessId => {
                const business = findBusinessById(businessId);
                if (business) {
                    const isOutOfStock = business.stock !== undefined && business.stock <= 0;
                    if (business.income > 0 && !isOutOfStock) {
                        totalIncome += getCustomBusinessIncome(business) * 30;
                    } else if (business.income > 0 && isOutOfStock) {
                        totalIncome += business.income * 30;
                    }
                    if (business.rent > 0 && business.id !== gameState.player.rentedPropertyId) {
                        totalRentIncome += business.rent;
                    }
                }
            });

            if (gameState.job) {
                const monthlySalary = gameState.job.salary * 8 * 20;
                const currentJob = getCurrentJobDetails();
                totalIncome += currentJob.salary * 8 * 20;
                addMoney(currentJob.salary * 8 * 20, `Salaire mensuel (${currentJob.title})`);
            }

            const taxAmount = totalIncome * taxRate;
            if (taxAmount > 0) {
                removeMoney(taxAmount, "Imp√¥t sur le revenu");
                showNotification(`Imp√¥t sur le revenu pay√©: -${taxAmount.toLocaleString()}$`, 'error');
            }

            if (totalRentIncome > 0) {
                addMoney(totalRentIncome, "Revenus locatifs");
                showNotification(`Revenus locatifs per√ßus: +${totalRentIncome.toLocaleString()}$`, 'success');
            }

            const rentedHome = gameState.player.rentedPropertyId ? findBusinessById(gameState.player.rentedPropertyId) : null;
            if (rentedHome && !gameState.ownedBusinesses.includes(rentedHome.id)) {
                removeMoney(rentedHome.rent, `Loyer (${rentedHome.name})`);
                showNotification(`Loyer pay√©: -${rentedHome.rent.toLocaleString()}$`, 'error');
            }

            if (gameState.loan && gameState.loan.remainingPayments > 0) {
                removeMoney(gameState.loan.monthlyPayment, "Remboursement du pr√™t");
                gameState.loan.remainingPayments--;
                showNotification(`Remboursement du pr√™t: -${gameState.loan.monthlyPayment.toLocaleString()}$`, 'error');
                if (gameState.loan.remainingPayments <= 0) gameState.loan = null;
            }

            if (gameState.player.hasChild) {
                removeMoney(500, "Frais pour l'enfant");
            }

            const allOwnedBusinesses = [...gameState.ownedBusinesses.map(id => findBusinessById(id)), ...gameState.customBusinesses];
            allOwnedBusinesses.forEach(biz => {
                if (biz.employees > 0) {
                    const salaries = biz.employees * 1500;
                    if (salaries > 0) {
                        removeMoney(salaries, `Salaires: ${biz.name}`);
                    }
                }
            });


        }

        function advanceTime(hours) {
            const startHour = gameState.time.hour;
            const endHour = (startHour + hours) % 24;

            gameState.needs.energy = Math.min(100, gameState.needs.energy + hours * 12.5);
            gameState.time.timeSinceSleep = 0;

            const sleepAnim = document.getElementById('sleep-animation');
            sleepAnim.classList.add('active');

            gameState.time.hour += hours;
            while (gameState.time.hour >= 24) {
                gameState.time.hour -= 24;
                gameState.time.day++;
            }

            setTimeout(() => sleepAnim.classList.remove('active'), 1500);
        }

        function improveSkill(skill, cost) {
            if (gameState.money >= cost) {
                let skillGain = 1;
                if (skill === 'intelligence' && hasItem('computer')) skillGain *= 1.2;
                removeMoney(cost, `Formation (${skill})`);
                gameState.player.skills[skill] += Math.round(skillGain);
                gameState.needs.energy -= 10;
                advanceTime(3);
                showNotification(`Comp√©tence ${skill} am√©lior√©e !`, 'success');
                renderUI();
            } else {
                showNotification("Fonds insuffisants pour √©tudier.", 'error');
            }
        }

        function eatAtHome() {
            if (gameState.money >= 15) {
                removeMoney(15, "Courses pour repas maison");
                gameState.needs.hunger = Math.min(100, gameState.needs.hunger + 60);
                advanceTime(0.5);
                showNotification("Vous avez mang√© un bon repas.", 'success');
            } else {
                showNotification("Pas assez d'argent pour manger.", 'error');
            }
        }

        function hasItem(itemId) {
            return gameState.player.inventory.some(item => item.id === itemId);
        }

        const mapStyle = `
            .location-icon { position: absolute; cursor: pointer; font-size: 2.5rem; transform: translate(-50%, -50%); transition: transform 0.2s; }
            .location-icon:hover { transform: translate(-50%, -50%) scale(1.2); }
            #player-marker { position: absolute; width: 20px; height: 20px; background-color: #e74c3c; border-radius: 50%; border: 2px solid white; transform: translate(-50%, -50%); transition: all 1s ease-in-out; }
        `;

        function findBusinessById(businessId) {
            for (const zone of gameState.world.zones) {
                if (zone.businesses) {
                    const business = zone.businesses.find(b => b.id === businessId);
                    if (business) return business;
                }
            }
            const customBusiness = gameState.customBusinesses.find(b => b.id === businessId);
            if (customBusiness) return customBusiness;
            return null;
        }

        window.buyBusiness = function(businessId) {
            const business = findBusinessById(businessId);
            if (!business) return;

            if (gameState.money >= business.price) {
                removeMoney(business.price, `Achat: ${business.name}`);
                gameState.ownedBusinesses.push(business.id);
                // Add management properties to newly bought business
                business.employees = 0;
                business.equipmentLevel = 0;
                business.trainingLevel = 0;
                business.decorationLevel = 0;
                business.marketingBoost = null;
                if (business.category === 'Boutique' || business.category === 'Restauration') business.stock = 100;
                showNotification(`F√©licitations ! Vous avez achet√© "${business.name}".`, 'success');
                renderBusinessList(gameState.world.zones.find(z => z.businesses?.some(b => b.id === businessId)));
                renderUI();
            } else {
                alert("Fonds insuffisants !");
            }
        }

        window.rentProperty = function(propertyId) {
            const newProperty = findBusinessById(propertyId);
            if (!newProperty) return;

            if (gameState.money >= newProperty.rent) {
                removeMoney(newProperty.rent, `Premier loyer: ${newProperty.name}`);
                gameState.player.rentedPropertyId = newProperty.id;
                
                const homeZone = gameState.world.zones.find(z => z.id === 'home');
                homeZone.name = `Mon ${newProperty.name}`;

                showNotification(`Vous avez emm√©nag√© dans: ${newProperty.name}. Premier loyer pay√©.`, 'success');
                updateActionButtons();
                renderUI();
            } else {
                alert("Fonds insuffisants pour le premier loyer !");
            }
        }

        window.showSellOffers = function(businessId) {
            const business = findBusinessById(businessId);
            if (!business) return;

            const sellModal = document.getElementById('sell-modal');
            document.getElementById('sell-modal-title').textContent = `Offres pour: ${business.name}`;
            const offersList = document.getElementById('offers-list');
            offersList.innerHTML = '';

            const offerCount = 2 + Math.floor(Math.random() * 2);
            const buyers = ['Investisseur local', 'Grand conglom√©rat', 'Jeune couple', 'Sp√©culateur immobilier'];
            for (let i = 0; i < offerCount; i++) {
                const offerPrice = business.price * (0.9 + Math.random() * 0.25);
                const offerEl = document.createElement('div');
                offerEl.className = 'job-listing';
                offerEl.innerHTML = `<div><h4>${buyers[Math.floor(Math.random() * buyers.length)]}</h4><p>Offre: ${Math.round(offerPrice).toLocaleString()}$</p></div><button class="menu-btn" onclick="sellProperty('${businessId}', ${Math.round(offerPrice)})">Accepter</button>`;
                offersList.appendChild(offerEl);
            }
            sellModal.classList.add('active');
        }

        function renderOwnedBusinesses() {
            const listEl = document.getElementById('owned-businesses-list');
            listEl.innerHTML = '';
            gameState.ownedBusinesses.forEach(businessId => {
                const business = findBusinessById(businessId);
                if (business) {
                    const itemEl = document.createElement('p');
                    let incomeString = '';
                    if (business.income > 0) {
                        incomeString = ` (+${business.income.toLocaleString()}$/j)`;
                    } else if (business.rent > 0) {
                        incomeString = ` (Revenu locatif: +${business.rent.toLocaleString()}$/m)`;
                    }
                    itemEl.innerHTML = `<strong>${business.name}</strong>${incomeString}`;
                    listEl.appendChild(itemEl);
                }
            });
        }

    function updateActionButtons() {
        const currentLocation = gameState.world.zones.find(z => z.id === gameState.player.currentLocationId);
        const actionButtonsContainer = document.getElementById('contextual-actions');
        actionButtonsContainer.innerHTML = '';

        const actionsWrapper = document.createElement('div');

        if (gameState.job && jobsData[gameState.job.trackId].zone === gameState.player.currentLocationId) {
            const workBtn = document.createElement('button');
            workBtn.className = 'menu-btn';
            workBtn.textContent = 'Travailler dur';
            workBtn.onclick = workHarder;
            actionsWrapper.appendChild(workBtn);

            const promotionProgress = document.createElement('p');
            const currentJob = getCurrentJobDetails();
            const performanceNeeded = currentJob.performanceToPromote || 'MAX';
            promotionProgress.innerHTML = `Performance: ${gameState.job.performance} / ${performanceNeeded}`;
            actionsWrapper.appendChild(promotionProgress);
        }

        actionsWrapper.style.display = 'flex';
        actionsWrapper.style.flexDirection = 'column';
        actionsWrapper.style.gap = '1rem';

        if (currentLocation) {
            document.getElementById('main-panel-title').textContent = `Actions √†: ${currentLocation.name}`;
            
            if (currentLocation.id === 'office') {
                const createBizBtn = document.createElement('button');
                createBizBtn.className = 'menu-btn';
                createBizBtn.textContent = 'Cr√©er une entreprise';
                createBizBtn.onclick = () => showCreateBusinessForm();
                actionsWrapper.appendChild(createBizBtn);
            }
            if (currentLocation.id === 'airport') {
                const travelBtn = document.createElement('button');
                travelBtn.className = 'menu-btn';
                travelBtn.textContent = 'Acheter un billet d\'avion';
                travelBtn.onclick = () => showTravelDestinations();
                actionsWrapper.appendChild(travelBtn);
            }
            if (currentLocation.id === 'university') {
                const researchBtn = document.createElement('button');
                researchBtn.className = 'menu-btn';
                researchBtn.textContent = 'Investir dans la recherche';
                researchBtn.onclick = () => showResearchProjects();
                actionsWrapper.appendChild(researchBtn);
            }
            if (currentLocation.id === 'luxury_mall') {
                luxuryItems.forEach(item => {
                    if (!gameState.player.inventory.find(i => i.id === item.id)) {
                        const btn = document.createElement('button');
                        btn.className = 'menu-btn';
                        btn.textContent = `Acheter ${item.name} (${item.cost.toLocaleString()}$)`;
                        btn.onclick = () => buyLuxuryItem(item.id);
                        actionsWrapper.appendChild(btn);
                    }
                });
            }
            if (currentLocation.id === 'car_dealership') {
                const exploreBtn = document.createElement('button');
                exploreBtn.className = 'menu-btn';
                exploreBtn.textContent = `Voir les v√©hicules`;
                exploreBtn.onclick = () => renderVehicleList();
                actionsWrapper.appendChild(exploreBtn);

                if (gameState.player.vehicle) {
                    const paintBtn = document.createElement('button');
                    paintBtn.className = 'menu-btn';
                    paintBtn.textContent = `Repeindre le v√©hicule (1000$)`;
                    paintBtn.onclick = () => paintVehicle();
                    actionsWrapper.appendChild(paintBtn);

                    const sellBtn = document.createElement('button');
                    sellBtn.className = 'menu-btn';
                    sellBtn.style.backgroundColor = '#e67e22';
                    const currentVehicle = vehicleData.find(v => v.id === gameState.player.vehicle.id);
                    const sellPrice = Math.floor(currentVehicle.cost * 0.7);
                    sellBtn.textContent = `Vendre mon ${currentVehicle.name} (${sellPrice.toLocaleString()}$)`;
                    sellBtn.onclick = () => sellCurrentVehicle();
                    actionsWrapper.appendChild(sellBtn);
                }
            }
            if (currentLocation.id === 'hospital') {
                const consultBtn = document.createElement('button');
                consultBtn.className = 'menu-btn';
                consultBtn.textContent = 'Consulter un m√©decin (150$)';
                consultBtn.onclick = () => seeDoctor();
                actionsWrapper.appendChild(consultBtn);
            }
            if (currentLocation.id === 'pawn_shop') {
                const sellItemBtn = document.createElement('button');
                sellItemBtn.className = 'menu-btn';
                sellItemBtn.textContent = 'Vendre un objet de luxe';
                sellItemBtn.onclick = () => showSellableItems();
                const sellableItems = gameState.player.inventory.filter(item => luxuryItems.some(li => li.id === item.id));
                if (sellableItems.length === 0) {
                    sellItemBtn.disabled = true;
                    sellItemBtn.textContent = 'Aucun objet √† vendre';
                }
                actionsWrapper.appendChild(sellItemBtn);
            }
            if (currentLocation.id === 'charity_org') {
                const donations = [
                    { amount: 100, happiness: 10 },
                    { amount: 500, happiness: 30 },
                    { amount: 1000, happiness: 50 }
                ];
                donations.forEach(donation => {
                    const btn = document.createElement('button');
                    btn.className = 'menu-btn';
                    btn.textContent = `Faire un don de ${donation.amount.toLocaleString()}$`;
                    btn.onclick = () => {
                        removeMoney(donation.amount, 'Don caritatif');
                        gameState.needs.happiness = Math.min(100, gameState.needs.happiness + donation.happiness);
                        gameState.player.reputation = Math.min(100, gameState.player.reputation + (donation.amount / 100));
                        showNotification(`Merci pour votre g√©n√©rosit√© ! Vous vous sentez bien.`, 'success');
                    };
                    actionsWrapper.appendChild(btn);
                });
            }


            if (currentLocation.actions) {
                if (currentLocation.id === 'home') {
                    const sleepBtn = document.createElement('button');
                    sleepBtn.className = 'menu-btn';
                    sleepBtn.textContent = 'Dormir';
                    sleepBtn.onclick = () => openSleepModal();
                    actionsWrapper.appendChild(sleepBtn);

                    const eatBtn = document.createElement('button');
                    eatBtn.className = 'menu-btn';
                    eatBtn.textContent = 'Manger';
                    eatBtn.onclick = () => showEatAtHomeOptions();
                    actionsWrapper.appendChild(eatBtn);

                    const customizeBtn = document.createElement('button');
                    customizeBtn.className = 'menu-btn';
                    customizeBtn.textContent = "Personnaliser l'appartement";
                    customizeBtn.onclick = () => showHomeCustomization();
                    actionsWrapper.appendChild(customizeBtn);

                    const partyBtn = document.createElement('button');
                    partyBtn.className = 'menu-btn'; 
                    partyBtn.textContent = "Organiser un √©v√©nement"; 
                    partyBtn.onclick = () => showPartyOptions(); 
                    actionsWrapper.appendChild(partyBtn);

                } else {
                    currentLocation.actions.forEach(action => { const btn = document.createElement('button'); btn.className = 'menu-btn'; btn.textContent = action.label; btn.onclick = action.onComplete; actionsWrapper.appendChild(btn); });
                }

            }
            if (currentLocation.id === 'home') {
                const manageHomeBtn = document.createElement('button');
                manageHomeBtn.className = 'menu-btn';
                manageHomeBtn.textContent = 'G√©rer la propri√©t√©';
                manageHomeBtn.onclick = () => {
                    togglePhoneApp('properties');
                    manageProperty(gameState.player.rentedPropertyId);
                };
                actionsWrapper.appendChild(manageHomeBtn);
            }

            if (currentLocation.businesses && currentLocation.businesses.length > 0 && currentLocation.id !== 'home') {
                const exploreBtn = document.createElement('button');
                exploreBtn.className = 'menu-btn';
                exploreBtn.textContent = `Explorer les propri√©t√©s (${currentLocation.businesses.length})`;
                exploreBtn.onclick = () => renderBusinessList(currentLocation);
                actionsWrapper.appendChild(exploreBtn);
            }

            actionButtonsContainer.appendChild(actionsWrapper);

            if (actionButtonsContainer.childElementCount === 0) {
                actionButtonsContainer.innerHTML = '<p>Rien √† faire ici pour le moment.</p>';
            }
        } else {
            actionButtonsContainer.innerHTML = '<p>D√©placez-vous pour voir les actions.</p>';
        }
    }

    function renderBusinessList(zone) {
        const actionButtonsContainer = document.getElementById('contextual-actions');
        actionButtonsContainer.innerHTML = '';

        const backBtn = document.createElement('button');
        backBtn.className = 'menu-btn';
        backBtn.textContent = 'Retour';
        backBtn.style.marginBottom = '1rem';
        backBtn.style.backgroundColor = 'rgba(0, 0, 0, 0.3)';
        backBtn.onclick = () => updateActionButtons();
        actionButtonsContainer.appendChild(backBtn);

        const categories = ['Toutes les cat√©gories', ...new Set(zone.businesses.map(b => b.category || 'Autre'))];
        
        if (categories.length > 2) {
            const filterContainer = document.createElement('div');
            filterContainer.style.display = 'flex';
            filterContainer.style.gap = '1rem';
            filterContainer.style.flexWrap = 'wrap';
            filterContainer.style.marginBottom = '1rem';

            categories.forEach(category => {
                const btn = document.createElement('button');
                btn.textContent = category;
                btn.className = 'menu-btn';
                btn.style.padding = '0.5rem 1rem';
                btn.style.fontSize = '0.9rem';
                btn.onclick = () => {
                    document.querySelectorAll('.business-listing').forEach(el => {
                        el.style.display = (category === 'Toutes les cat√©gories' || el.dataset.category === category) ? 'flex' : 'none';
                    });
                };
                filterContainer.appendChild(btn);
            });
            actionButtonsContainer.appendChild(filterContainer);
        }

        zone.businesses.forEach(business => {
            const businessEl = document.createElement('div');
            businessEl.className = 'business-listing';

            const isOwned = gameState.ownedBusinesses.includes(business.id);
            const isRented = gameState.player.rentedPropertyId === business.id;

            let buttonHtml;
            if (isOwned) {
                buttonHtml = `<button class="menu-btn" style="background-color: #e67e22;" onclick="showSellOffers('${business.id}')">Vendre</button>`;
            } else if (isRented) {
                buttonHtml = `<div class="owned-tag" style="background-color: var(--primary-color); color: white; border-color: var(--primary-color);">Lou√©</div>`;
            } else if (business.rent > 0 && business.income === 0) {
                buttonHtml = `
                    <div style="display: flex; gap: 1rem;">
                        <button class="menu-btn" style="background-color: var(--success-color); flex: 1;" onclick="rentProperty('${business.id}')" ${gameState.money < business.rent ? 'disabled' : ''}>Louer (${business.rent.toLocaleString()}$/mois)</button>
                        <button class="menu-btn" style="flex: 2;" onclick="buyBusiness('${business.id}')" ${gameState.money < business.price ? 'disabled' : ''}>Acheter (${business.price.toLocaleString()}$)</button>
                    </div>`;
            } else {
                buttonHtml = `<button class="menu-btn" onclick="buyBusiness('${business.id}')" ${gameState.money < business.price ? 'disabled' : ''}>Acheter (${business.price.toLocaleString()}$)</button>`;
            }

            const incomeText = business.income > 0 ? `<p class="business-details">Revenu: ${business.income.toLocaleString()}$ / jour</p>` : '';
            const rentText = business.rent > 0 ? `<p class="business-details">Loyer / Revenu locatif: ${business.rent.toLocaleString()}$ / mois</p>` : '';
            const descriptionText = business.description ? `<p class="business-details">${business.description}</p>` : (business.category ? `<p class="business-details">Cat√©gorie: ${business.category || 'Autre'}</p>` : '');

            businessEl.innerHTML = `
                <div>
                    <h4>${business.name}</h4>
                    <div class="business-details">
                        ${descriptionText}
                        ${incomeText}
                        ${rentText}
                    </div>
                </div>
                <div style="min-width: 250px; text-align: right;">
                    ${buttonHtml}
                </div>
            `;
            businessEl.dataset.category = business.category || 'Autre';
            actionButtonsContainer.appendChild(businessEl);
        });
    }

    function openSleepModal() {
        const sleepModal = document.getElementById('sleep-modal');
        const sleepOptions = document.getElementById('sleep-options');
        sleepOptions.innerHTML = '';

        const options = [
            { label: 'Sieste (2h)', hours: 2 },
            { label: 'Bonne nuit (6h)', hours: 6 },
            { label: 'Nuit compl√®te (8h)', hours: 8 },
        ];

        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'menu-btn';
            btn.textContent = opt.label;
            btn.onclick = () => {
                advanceTime(opt.hours);
                sleepModal.classList.remove('active');
            };
            sleepOptions.appendChild(btn);
        });

        sleepModal.classList.add('active');
    }

    function applyMarketChange(priceMod, rentMod, incomeMod) {
        gameState.world.zones.forEach(zone => {
            if (zone.businesses) {
                zone.businesses.forEach(business => {
                    business.price = Math.round(business.price * priceMod);
                    if (business.rent > 0) {
                        business.rent = Math.round(business.rent * rentMod);
                    }
                    if (business.income > 0) {
                        business.income = Math.round(business.income * incomeMod);
                    }
                });
            }
        });
    }

    function travelTo(zone) {
        gameState.player.currentLocationId = zone.id;
        updateActionButtons();
    }

    function openInventory() {
        const inventoryModal = document.getElementById('inventory-modal');
        const inventoryList = document.getElementById('inventory-list');
        inventoryList.innerHTML = '';
        if (gameState.player.inventory.length === 0) {
            inventoryList.innerHTML = '<p>Votre inventaire est vide.</p>';
        } else {
            gameState.player.inventory.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'job-listing';
                itemEl.textContent = item.name;
                inventoryList.appendChild(itemEl);
            });
        }
        inventoryModal.classList.add('active');
    }

    function initialize() {
        const continueBtn = document.getElementById('continue-btn');
        if (!localStorage.getItem(SAVE_KEY)) {
            continueBtn.disabled = true;
        }

        document.getElementById('travel-btn').addEventListener('click', () => {
            const travelModal = document.getElementById('travel-modal');
            const locationsList = document.getElementById('locations-list');
            locationsList.innerHTML = '';

            gameState.world.zones.forEach(zone => {
                const locationEl = document.createElement('div');
                locationEl.className = 'job-listing';
                let zoneName = zone.name;
                if (zone.id === 'home' && gameState.player.rentedPropertyId) {
                    const currentHome = findBusinessById(gameState.player.rentedPropertyId);
                    zoneName = currentHome ? `Mon ${currentHome.name}` : zone.name;
                }
                locationEl.innerHTML = `<h4>${zone.icon} ${zoneName}</h4>`;

                if (zone.id === gameState.player.currentLocationId) {
                    locationEl.style.backgroundColor = 'rgba(82, 148, 226, 0.3)';
                } else {
                    locationEl.style.cursor = 'pointer';
                    locationEl.onclick = () => {
                        travelTo(zone);
                        travelModal.classList.remove('active');
                    };
                }
                if (!zone.isHomelessShelter) {
                    locationsList.appendChild(locationEl);
                }
            });
            travelModal.classList.add('active');
        });

        document.getElementById('travel-modal').addEventListener('click', (e) => {
            if (e.target.id === 'travel-modal') {
                document.getElementById('travel-modal').classList.remove('active');
            }
        });

        document.getElementById('refuse-sell-btn').addEventListener('click', () => {
            document.getElementById('sell-modal').classList.remove('active');
        });

        document.getElementById('sell-modal').addEventListener('click', (e) => {
            if (e.target.id === 'sell-modal') {
                document.getElementById('sell-modal').classList.remove('active');
            }
        });

        document.getElementById('event-modal').addEventListener('click', (e) => {
            if (e.target.id === 'event-modal') {
            }
        });

        document.getElementById('close-history-btn').addEventListener('click', () => {
            document.getElementById('history-modal').classList.remove('active');
        });

        document.getElementById('cancel-sleep-btn').addEventListener('click', () => {
            document.getElementById('sleep-modal').classList.remove('active');
        });

        document.getElementById('sleep-modal').addEventListener('click', (e) => {
            if (e.target.id === 'sleep-modal') {
                document.getElementById('sleep-modal').classList.remove('active');
            }
        });

        document.getElementById('close-inventory-btn').addEventListener('click', () => {
            document.getElementById('inventory-modal').classList.remove('active');
        });
         document.getElementById('inventory-modal').addEventListener('click', (e) => {
            if (e.target.id === 'inventory-modal') {
                document.getElementById('inventory-modal').classList.remove('active');
            }
        });

        document.getElementById('back-to-menu-btn').addEventListener('click', () => {
            if (gameState) {
                localStorage.setItem(SAVE_KEY, JSON.stringify(gameState));
                document.getElementById('continue-btn').disabled = false;
            }
            switchScreen('main-menu');
        });

        document.getElementById('status-app-btn').addEventListener('click', () => togglePhoneApp('status'));
        document.getElementById('needs-app-btn').addEventListener('click', () => togglePhoneApp('needs'));
        document.getElementById('bank-app-btn').addEventListener('click', () => togglePhoneApp('bank'));
        document.getElementById('portfolio-app-btn').addEventListener('click', () => togglePhoneApp('portfolio'));
        document.getElementById('stocks-app-btn').addEventListener('click', () => togglePhoneApp('stocks'));
        document.getElementById('jobs-app-btn').addEventListener('click', () => togglePhoneApp('jobs'));
        document.getElementById('social-app-btn').addEventListener('click', () => togglePhoneApp('social'));
        document.getElementById('inventory-app-btn').addEventListener('click', () => togglePhoneApp('inventory'));
        document.getElementById('properties-app-btn').addEventListener('click', () => togglePhoneApp('properties'));
        document.getElementById('ranking-app-btn').addEventListener('click', () => togglePhoneApp('ranking'));
        document.getElementById('delivery-app-btn').addEventListener('click', () => togglePhoneApp('delivery'));
        document.getElementById('objectives-app-btn').addEventListener('click', () => togglePhoneApp('objectives'));

        document.getElementById('staff-button').addEventListener('click', openStaffMenu);
        document.getElementById('close-staff-btn').addEventListener('click', () => {
            document.getElementById('staff-modal').classList.remove('active');
        });
        setupNewsTicker();

        const styleSheet = document.createElement("style");
        styleSheet.innerText = mapStyle;
        document.head.appendChild(styleSheet);
    }

    function showNotification(message, type = 'success') {
        const notif = document.createElement('div');
        notif.className = `notification ${type}`;
        notif.textContent = message;
        document.getElementById('notification-container').appendChild(notif);
        setTimeout(() => notif.remove(), 3500);
    }

    function sellProperty(businessId, price) {
        const businessIndex = gameState.ownedBusinesses.findIndex(id => id === businessId);
        if (businessIndex > -1) {
            const business = findBusinessById(businessId);
            addMoney(price, `Vente: ${business.name}`);
            gameState.ownedBusinesses.splice(businessIndex, 1);
            showNotification(`Vous avez vendu "${business.name}" pour ${price.toLocaleString()}$ !`, 'success');
            document.getElementById('sell-modal').classList.remove('active');
            renderBusinessList(gameState.world.zones.find(z => z.id === gameState.player.currentLocationId));
            renderUI();
        }
    }

    function logTransaction(description, amount) {
        gameState.player.transactions.push({ description, amount });
        if (gameState.player.transactions.length > 50) {
            gameState.player.transactions.shift();
        }
    }
    function addMoney(amount, description) {
        gameState.money += amount;
        logTransaction(description, amount);
    }
    function removeMoney(amount, description) {
        gameState.money -= amount;
        logTransaction(description, -amount);
    }

    function openHistoryModal() {
        const historyModal = document.getElementById('history-modal');
        const historyList = document.getElementById('history-list');
        historyList.innerHTML = '';

        if (gameState.player.transactions.length === 0) {
            historyList.innerHTML = '<p>Aucune transaction.</p>';
        } else {
            [...gameState.player.transactions].reverse().forEach(tx => {
                const txEl = document.createElement('div');
                txEl.className = 'job-listing';
                const amountColor = tx.amount > 0 ? 'var(--success-color)' : '#e74c3c';
                txEl.innerHTML = `
                    <span>${tx.description}</span>
                    <span style="color: ${amountColor}; font-weight: bold;">${tx.amount.toLocaleString()}$</span>
                `;
                historyList.appendChild(txEl);
            });
        }
        historyModal.classList.add('active');
    }

    function updateBankUI(container = null) {
        const loanInfoContainer = container || document.getElementById('loan-info');
        loanInfoContainer.innerHTML = '';

        if (gameState.loan) {
            const remainingAmount = gameState.loan.monthlyPayment * gameState.loan.remainingPayments;
            loanInfoContainer.innerHTML = `
                <p><strong>Pr√™t en cours</strong></p>
                <p>Restant: ${remainingAmount.toLocaleString()}$</p>
                <p>Paiement: ${gameState.loan.monthlyPayment.toLocaleString()}$/mois</p>
                <p>√âch√©ances: ${gameState.loan.remainingPayments}</p>
            `;
        } else {
            const loanOptions = [
                { amount: 5000, term: 6 },
                { amount: 20000, term: 12 },
            ];
            loanOptions.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'menu-btn';
                btn.style.fontSize = '0.8rem';
                btn.style.padding = '0.6rem';
                btn.style.marginBottom = '0.4rem';
                btn.textContent = `Emprunter ${opt.amount.toLocaleString()}$`;
                btn.onclick = () => takeLoan(opt.amount, opt.term);
                loanInfoContainer.appendChild(btn);
            });
        }
    }

    function takeLoan(amount, term) {
        if (gameState.loan) {
            showNotification("Vous avez d√©j√† un pr√™t en cours.", 'error');
            return;
        }
        const interestRate = 1.1;
        const totalToRepay = amount * interestRate;
        const monthlyPayment = Math.ceil(totalToRepay / term);

        gameState.loan = {
            principal: amount,
            monthlyPayment: monthlyPayment,
            remainingPayments: term
        };

        addMoney(amount, `Pr√™t de ${amount.toLocaleString()}$`);
        showNotification(`Vous avez emprunt√© ${amount.toLocaleString()}$ !`, 'success');
        updateBankUI();
    }

    function getCurrentJobDetails() {
        if (!gameState.job) return null;
        const track = jobsData[gameState.job.trackId];
        if (!track) return null;
        return track.levels[gameState.job.levelIndex];
    }

    function workHarder() {
        gameState.job.performance += 5;
        gameState.needs.energy -= 15;
        advanceTime(2);
        showNotification("Vous avez bien travaill√© !", 'success');
        checkForPromotion();
        updateActionButtons();
    }

    function checkForPromotion() {
        const currentJob = getCurrentJobDetails();
        const track = jobsData[gameState.job.trackId];

        if (!currentJob.performanceToPromote || gameState.job.levelIndex >= track.levels.length - 1) {
            return;
        }

        if (gameState.job.performance >= currentJob.performanceToPromote) {
            const nextJob = track.levels[gameState.job.levelIndex + 1];
            let canPromote = true;
            for (const skill in nextJob.requiredSkills) {
                if (gameState.player.skills[skill] < nextJob.requiredSkills[skill]) {
                    canPromote = false;
                    break;
                }
            }

            if (canPromote) {
                gameState.job.levelIndex++;
                gameState.job.performance = 0;
                showNotification(`F√©licitations ! Vous avez √©t√© promu: ${nextJob.title}`, 'success');
            } else {
                showNotification("Vous avez la performance pour une promotion, mais pas les comp√©tences requises.", 'info');
            }
        }
    }


    function togglePhoneApp(appName) {
        const phoneScreen = document.getElementById('phone-screen');
        const currentApp = phoneScreen.dataset.currentApp;

        let contentHtml = '';
        let title = '';

        switch(appName) {
            case 'status':
                title = 'Statut & Comp√©tences';
                const currentJobDetails = getCurrentJobDetails();
                contentHtml = `
                    <p><strong>Emploi:</strong> ${currentJobDetails ? currentJobDetails.title : 'Sans emploi'}</p>
            <hr style="border-color: var(--border-color); margin: 0.5rem 0;">
                    <h3>Comp√©tences</h3>
            <p>Charisme: ${getEffectiveSkill('charisma')}</p>
            <p>Intelligence: ${getEffectiveSkill('intelligence')}</p>
            <p>Manuel: ${getEffectiveSkill('manual')}</p>
            <p><strong>R√©putation:</strong> ${Math.round(gameState.player.reputation)} / 100</p>
                `;
                break;
            case 'needs':
                title = 'Besoins';
                contentHtml = `
                    <label>√ânergie</label>
                    <div class="stat-bar-container" style="margin-bottom: 1rem;"><div class="stat-bar" style="width: ${gameState.needs.energy}%; background-color: var(--energy-color);"></div></div>
                    <label>Bonheur</label>
                    <div class="stat-bar-container" style="margin-bottom: 1rem;"><div class="stat-bar" style="width: ${gameState.needs.happiness}%; background-color: var(--happiness-color);"></div></div>
                    <label>Faim</label>
                    <div class="stat-bar-container"><div class="stat-bar" style="width: ${gameState.needs.hunger}%; background-color: #e67e22;"></div></div>
                    <label>Sant√©</label>
                    <div class="stat-bar-container" style="margin-top: 1rem;"><div id="health-bar" class="stat-bar" style="width: ${gameState.needs.health}%;"></div></div>
                    ${gameState.player.sickness ? `<p style="color: #e74c3c; text-align: center; margin-top: 1rem;">Malade: ${gameState.player.sickness.name}</p>` : ''}
                `;
                break;
            case 'bank':
                title = 'Banque';
                contentHtml = `<div id="loan-info-container"></div><button id="history-btn-app" class="menu-btn" style="width:100%; margin-top:0.5rem;">Voir l'historique</button>`;
                break;
            case 'portfolio':
                title = 'Mon Portfolio';
                if (gameState.ownedBusinesses.length === 0) {
                    contentHtml = '<p>Vous ne poss√©dez aucune entreprise.</p>';
                } else {
                    let portfolioHtml = '<h4>Entreprises Achet√©es</h4>';
                    gameState.ownedBusinesses.forEach(businessId => {
                        const business = findBusinessById(businessId);
                        if (business) {
                            portfolioHtml += `<div class="business-listing"><span><strong>${business.name}</strong> (+${business.income > 0 ? business.income.toLocaleString() + '$/j' : business.rent.toLocaleString() + '$/m'})</span></div>`;
                        }
                    });
                    if (gameState.customBusinesses.length > 0) {
                        portfolioHtml += '<hr style="border-color: var(--border-color); margin: 1rem 0;"><h4>Entreprises Cr√©es</h4>';
                        gameState.customBusinesses.forEach(business => {
                            portfolioHtml += `<div class="business-listing"><span><strong>${business.name}</strong> (+${getCustomBusinessIncome(business).toLocaleString()}$/j)</span><button class="menu-btn" style="font-size:0.8rem; padding:0.4rem 0.8rem;" onclick="manageBusiness('${business.id}')">G√©rer</button></div>`;
                        });
                    }
                    contentHtml = portfolioHtml;
                }
                break;
            case 'ranking':
                title = 'Classement des Fortunes';
                const playerNetWorth = calculateNetWorth(gameState.money, gameState.ownedBusinesses);
                const players = [{ name: 'Vous', netWorth: playerNetWorth }];

                gameState.competitors.forEach(c => {
                    players.push({ name: c.name, netWorth: calculateNetWorth(c.money, c.ownedBusinesses) });
                });

                players.sort((a, b) => b.netWorth - a.netWorth);

                let rankingHtml = '';
                players.forEach((p, index) => {
                    rankingHtml += `<p><strong>#${index + 1} ${p.name}</strong>: ${p.netWorth.toLocaleString()}$</p>`;
                });
                contentHtml = rankingHtml;

                break;
            case 'properties':
                title = 'Mes Propri√©t√©s';
                contentHtml = `
                    <div style="display: flex; height: 100%; gap: 1rem;">
                        <div id="property-list-container" style="flex: 2; overflow-y: auto; border-right: 1px solid var(--border-color); padding-right: 1rem;"></div>
                        <div id="property-management-container" style="flex: 3;">
                            <p>S√©lectionnez une propri√©t√© pour la g√©rer.</p>
                        </div>
                    </div>
                `;
                break;
            case 'jobs':
                if (gameState.job) {
                    const currentJob = getCurrentJobDetails(); title = 'Mon Emploi'; contentHtml = `<p><strong>Poste:</strong> ${currentJob.title}</p><p><strong>Salaire:</strong> ${currentJob.salary}$/h</p><p><strong>Performance:</strong> ${gameState.job.performance} / ${currentJob.performanceToPromote || 'MAX'}</p><button class="menu-btn" style="width:100%; margin-top:1rem; background-color: #c0392b;" onclick="resignFromJob()">D√©missionner</button>`;
                } else {
                    title = 'Offres d\'emploi'; let jobsHtml = ''; for (const trackId in jobsData) {
                        const track = jobsData[trackId]; const job = track.levels[0]; jobsHtml += `<div class="business-listing"><div><strong>${job.title}</strong><br><small>Salaire: ${job.salary}$/h</small></div><button class="menu-btn" style="font-size:0.8rem; padding:0.4rem 0.8rem;" onclick="applyForJob('${trackId}')">Postuler</button></div>`;
                    } contentHtml = jobsHtml;
                }
                break;
            case 'social':
                title = 'Relations'; let socialHtml = ''; for (const id in gameState.player.relationships) {
                    const contact = gameState.player.relationships[id]; socialHtml += `<div class="business-listing"><span>${contact.name} (${Math.round(contact.relationship)}%)</span><button class="menu-btn" style="font-size:0.8rem; padding:0.4rem 0.8rem;" onclick="interactWith('${id}')">Interagir</button></div>`;
                }
                if (gameState.player.partner) {
                    const partner = gameState.player.partner; const status = partner.isMarried ? ' (Mari√©(e))' : ' (Partenaire)'; socialHtml += `<div class="business-listing"><span>${partner.name}${status} (${Math.round(partner.relationship)}%)</span><button class="menu-btn" style="font-size:0.8rem; padding:0.4rem 0.8rem;" onclick="interactWith('partner')">Interagir</button></div>`;
                }
                if (gameState.player.hasChild) {
                    socialHtml += `<p style="text-align: center; margin-top: 1rem;">Vous avez un enfant.</p>`;
                }
                contentHtml = socialHtml;
                break;
            case 'inventory':
                title = 'Inventaire'; let inventoryHtml = '';
                if (gameState.player.vehicle) {
                    const vehicle = vehicleData.find(v => v.id === gameState.player.vehicle.id); inventoryHtml += `<p><strong>V√©hicule:</strong> ${vehicle.name} (${gameState.player.vehicle.color})</p>`;
                }
                const luxuryObjects = gameState.player.inventory.filter(item => luxuryItems.some(li => li.id === item.id));
                if (luxuryObjects.length > 0) {
                    inventoryHtml += '<hr><h4>Objets de Luxe</h4>';
                    luxuryObjects.forEach(item => { inventoryHtml += `<p><strong>- ${item.name}</strong></p>`; });
                }
                if (inventoryHtml === '') {
                    contentHtml = '<p>Votre inventaire est vide.</p>';
                } else {
                    contentHtml = inventoryHtml;
                }
                break;
            case 'stocks':
                title = 'Bourse';
                let allStocks = [...gameState.world.stocks];

                gameState.competitors.forEach(c => {
                    let competitorStock = allStocks.find(s => s.competitorName === c.name);
                    if (!competitorStock) {
                        const netWorth = calculateNetWorth(c.money, c.ownedBusinesses);
                        const newStock = { symbol: c.name.substring(0, 4).toUpperCase(), name: `Portefeuille de ${c.name}`, price: netWorth / 1000, volatility: 2.5, history: [netWorth/1000], isCompetitor: true, competitorName: c.name };
                        allStocks.push(newStock);
                    } else {
                        // Update existing competitor stock
                        const netWorth = calculateNetWorth(c.money, c.ownedBusinesses);
                        competitorStock.price = netWorth / 1000;
                        competitorStock.history.push(competitorStock.price);
                        if (competitorStock.history.length > 50) competitorStock.history.shift();
                    }
                });

                gameState.world.stocks = allStocks; // Update the main list

                let stocksHtml = '<h3>March√©</h3>'; allStocks.forEach(stock => {
                    stocksHtml += `<div class="business-listing"><div style="flex-grow: 1;"><strong>${stock.symbol}</strong> - ${stock.price.toFixed(2)}$<br><small>${stock.name}</small></div><div style="width: 100px; margin: 0 10px;">${generateStockChart(stock.history)}</div><div><button class="menu-btn" style="font-size:0.8rem; padding:0.4rem 0.8rem;" onclick="buyStock('${stock.symbol}')">Acheter</button></div></div>`;
                });
                stocksHtml += '<hr style="border-color: var(--border-color); margin: 1rem 0;"><h3>Mon Portefeuille</h3>'; const ownedStocks = Object.keys(gameState.player.portfolio.stocks);
                if (ownedStocks.length === 0) {
                    stocksHtml += '<p>Vous ne poss√©dez aucune action.</p>';
                } else {
                    ownedStocks.forEach(symbol => {
                        const holding = gameState.player.portfolio.stocks[symbol]; const stock = allStocks.find(s => s.symbol === symbol); const currentValue = holding.shares * stock.price; stocksHtml += `<div class="business-listing"><div><strong>${holding.shares} ${symbol}</strong><br><small>Valeur: ${currentValue.toFixed(2)}$</small></div><button class="menu-btn" style="font-size:0.8rem; padding:0.4rem 0.8rem; background-color: #e67e22;" onclick="sellStock('${symbol}')">Vendre</button></div>`;
                    });
                }
                contentHtml = stocksHtml;
                break;
            case 'delivery':
                title = 'Se faire livrer';
                let restaurantListHtml = '';
                for (const restaurantId in restaurantData) {
                    const restaurant = restaurantData[restaurantId];
                    restaurantListHtml += `<div class="business-listing" style="cursor: pointer;" onclick="showRestaurantMenu('${restaurantId}')">
                        <span><strong>${restaurant.name}</strong><br><small>${restaurant.category}</small></span>
                    </div>`;
                }
                contentHtml = restaurantListHtml;
                break;
            case 'objectives':
                title = 'Objectifs';
                let objectivesHtml = '';
                for (const categoryId in objectivesData) {
                    const cat = objectivesData[categoryId];
                    objectivesHtml += `<h4>${cat.name}</h4>`; 
                    cat.objectives.forEach(obj => {
                        const isCompleted = gameState.player.completedObjectives.includes(obj.id);
                        objectivesHtml += `
                            <div class="business-listing" style="opacity: ${isCompleted ? 0.5 : 1};">
                                <div><span>${obj.text}</span><br><small style="color: #aaa;">R√©compense: ${obj.rewardText || 'Aucune'}</small></div> 
                                <span style="color: ${isCompleted ? 'var(--success-color)' : '#ccc'};">${isCompleted ? '‚úì Termin√©' : 'En cours'}</span>
                            </div>`;
                    });
                }
                contentHtml = objectivesHtml;
                break;
        }

        phoneScreen.classList.toggle('wide', appName === 'properties');

        if (phoneScreen.classList.contains('active') && currentApp === appName) {
            phoneScreen.classList.remove('active');
            phoneScreen.dataset.currentApp = '';
        } else {
            phoneScreen.innerHTML = `<div class="panel" style="height: 100%; display: flex; flex-direction: column;"><h2>${title}</h2><div style="flex-grow: 1; overflow-y: auto;">${contentHtml}</div></div>`;
            
            if (appName === 'bank') {
                const loanInfoContainer = phoneScreen.querySelector('#loan-info-container'); updateBankUI(loanInfoContainer); phoneScreen.querySelector('#history-btn-app').onclick = openHistoryModal;
            }

            if (appName === 'properties') {
                const propertyListContainer = document.getElementById('property-list-container');
                const allOwnedBusinesses = [...gameState.ownedBusinesses.map(id => findBusinessById(id)).filter(b => b), ...gameState.customBusinesses];
                const rentedProperty = findBusinessById(gameState.player.rentedPropertyId);
                
                const allProperties = [...allOwnedBusinesses];
                if (rentedProperty && !allProperties.some(p => p.id === rentedProperty.id)) {
                    allProperties.push(rentedProperty);
                }

                if (allProperties.length === 0) {
                    propertyListContainer.innerHTML = '<p>Vous ne poss√©dez ou ne louez aucune propri√©t√©.</p>';
                } else {
                    let propListHtml = '';
                    allProperties.forEach(prop => {
                        const isOwned = gameState.ownedBusinesses.includes(prop.id);
                        const income = prop.income > 0 ? `+${getCustomBusinessIncome(prop).toLocaleString()}$/j` : `+${prop.rent.toLocaleString()}$/m`;
                        const status = isOwned ? `(${income})` : '(Lou√©)';
                        propListHtml += `<div class="business-listing" style="cursor: pointer;" onmouseover="this.style.backgroundColor='rgba(255,255,255,0.1)'" onmouseout="this.style.backgroundColor='transparent'" onclick="manageProperty('${prop.id}')"><span><strong>${prop.name}</strong> ${status}</span></div>`;
                    });
                    propertyListContainer.innerHTML = propListHtml;
                }
            }

            if (appName === 'stocks') {
            }

            phoneScreen.classList.add('active');
            phoneScreen.dataset.currentApp = appName;
        }
    }

    function resignFromJob() {
        showNotification(`Vous avez d√©missionn√© de votre poste de ${getCurrentJobDetails().title}.`, 'info');
        gameState.job = null;
        togglePhoneApp('jobs');
    }

    function applyForJob(trackId) {
        const track = jobsData[trackId];
        const job = track.levels[0];
        const phoneScreen = document.getElementById('phone-screen');

        let interviewHtml = `
            <div class="panel" style="height: 100%; display: flex; flex-direction: column;">
                <h2>Entretien pour ${job.title}</h2>
                <div style="flex-grow: 1; overflow-y: auto;">
                    <p><strong>Recruteur :</strong> "Bonjour. Pourquoi devrions-nous vous embaucher ?"</p>
                    <div class="menu-buttons" style="margin-top: 1rem;">
        `;

        const responses = [
            { text: "Je suis tr√®s motiv√©(e) et j'apprends vite.", skillCheck: () => true, weight: 0 },
            { text: "[Charisme 20] Je suis la personne qu'il vous faut, mon dynamisme est contagieux.", skillCheck: () => gameState.player.skills.charisma >= 20, weight: 25 },
            { text: "[Intelligence 20] Mon analyse du poste indique que mes comp√©tences correspondent parfaitement.", skillCheck: () => gameState.player.skills.intelligence >= 20, weight: 25 },
            { text: "J'ai besoin d'argent.", skillCheck: () => true, weight: -20 }
        ];

        responses.forEach((response, index) => {
            if (response.skillCheck()) {
                interviewHtml += `<button class="menu-btn" style="font-size: 0.9rem; padding: 0.8rem;" onclick="handleJobResponse('${trackId}', ${response.weight})">${response.text}</button>`;
            }
        });

        interviewHtml += `</div></div></div>`;
        phoneScreen.innerHTML = interviewHtml;
    }

    function handleJobResponse(trackId, weight) {
        const track = jobsData[trackId];
        const job = track.levels[0];
        let successChance = 30; // Base chance

        let missingSkills = [];
        const skillTranslations = { intelligence: 'Intelligence', charisma: 'Charisme', manual: 'Comp√©tence Manuelle' };

        for (const skill in job.requiredSkills) {
            if (getEffectiveSkill(skill) < job.requiredSkills[skill]) {
                missingSkills.push(skillTranslations[skill]);
            }
        }

        const phoneScreen = document.getElementById('phone-screen');
        let resultHtml = `<div class="panel" style="height: 100%;"><h2>R√©sultat de l'entretien</h2>`;

        if (missingSkills.length > 0) {
            resultHtml += `<p><strong>Recruteur :</strong> "Votre profil est int√©ressant, mais il semble que vous n'ayez pas encore les comp√©tences requises. Nous recherchons quelqu'un avec plus d'exp√©rience en ${missingSkills.join(', ')}."</p>`;
            showNotification("Vous n'avez pas les comp√©tences requises.", 'error');
        } else {
            successChance += 30; // Bonus for having skills
            successChance += weight; // Bonus/malus from interview response

            if (Math.random() * 100 < successChance) {
                resultHtml += `<p><strong>Recruteur :</strong> "Parfait, vous √™tes embauch√© ! Bienvenue chez nous."</p>`;
                gameState.job = { trackId: trackId, levelIndex: 0, performance: 0 };
                showNotification(`F√©licitations ! Vous avez √©t√© embauch√© comme ${job.title}.`, 'success');
            } else {
                resultHtml += `<p><strong>Recruteur :</strong> "Merci pour votre temps. La comp√©tition √©tait rude et nous avons d√©cid√© de poursuivre avec un autre candidat."</p>`;
                showNotification("Vous n'avez pas obtenu le poste cette fois-ci.", 'error');
            }
        }
        resultHtml += `</div>`;
        phoneScreen.innerHTML = resultHtml;
    }

    function interactWith(contactId) {
        const contact = contactId === 'partner' ? gameState.player.partner : gameState.player.relationships[contactId];
        const phoneScreen = document.getElementById('phone-screen');

        let interactionHtml = `
            <div class="panel" style="height: 100%; display: flex; flex-direction: column;">
                <h2>Interagir avec ${contact.name}</h2>
                <div class="menu-buttons" style="margin-top: 1rem;">
                    <button class="menu-btn" style="font-size: 0.9rem; padding: 0.8rem;" onclick="performInteraction('${contactId}', 'call')">Appeler (15min)</button>
                    <button class="menu-btn" style="font-size: 0.9rem; padding: 0.8rem;" onclick="performInteraction('${contactId}', 'visit')">Passer du temps (2h)</button>
                </div>
            </div>`;
        phoneScreen.innerHTML = interactionHtml;
    }

    function performInteraction(contactId, type) {
        const contact = contactId === 'partner' ? gameState.player.partner : gameState.player.relationships[contactId];
        if (type === 'call') {
            advanceTime(0.25);
            contact.relationship = Math.min(100, contact.relationship + (2 * (1 + (gameState.player.reputation - 50) / 200)));
            gameState.needs.happiness = Math.min(100, gameState.needs.happiness + 5);
            showNotification(`Vous avez appel√© ${contact.name}.`, 'success');
        } else if (type === 'visit') {
            advanceTime(2);
            contact.relationship = Math.min(100, contact.relationship + (15 * (1 + (gameState.player.reputation - 50) / 200)));
            gameState.needs.happiness = Math.min(100, gameState.needs.happiness + 35);
            showNotification(`Vous avez pass√© un excellent moment avec ${contact.name}.`, 'success');
        }
        togglePhoneApp('social');
    }

    function isBusinessOwned(businessId) {
        if (gameState.ownedBusinesses.includes(businessId)) return true;
        for (const competitor of gameState.competitors) {
            if (competitor.ownedBusinesses.includes(businessId)) return true;
        }
        return false;
    }



    function getEffectiveSkill(skill) {
        let value = gameState.player.skills[skill];
        gameState.player.inventory.forEach(item => {
            const luxuryItem = luxuryItems.find(li => li.id === item.id);
            if (luxuryItem && luxuryItem.bonus.type === 'skill' && luxuryItem.bonus.skill === skill) {
                value += luxuryItem.bonus.value;
            }
        });
        return value;
    }

    function calculateNetWorth(money, businessIds) {
        let worth = money;
        businessIds.forEach(id => {
            const business = findBusinessById(id);
            if (business) worth += business.price;
        });
        return Math.floor(worth);
    }




    function showLifeEvent(event) {
        const modal = document.getElementById('event-modal');
        document.getElementById('event-title').textContent = event.title;
        document.getElementById('event-description').textContent = event.description;
        const choicesContainer = document.getElementById('event-choices');
        choicesContainer.innerHTML = '';

        event.choices.forEach(choice => {
            if (choice.condition()) {
                const btn = document.createElement('button');
                btn.className = 'menu-btn';
                btn.textContent = choice.text;
                btn.onclick = () => {
                    choice.action();
                    modal.classList.remove('active');
                    gameInterval = setInterval(gameLoop, GAME_TICK_MS);
                };
                choicesContainer.appendChild(btn);
            }
        });
        modal.classList.add('active');
    }

    function showCreateBusinessForm() {
        const phoneScreen = document.getElementById('phone-screen');
        let businessTypes = [
            { name: 'Caf√©', cost: 100000, baseIncome: 800 },
            { name: 'Agence de conseil', cost: 50000, baseIncome: 1200 },
            { name: 'Startup Tech', cost: 250000, baseIncome: 2500 },
            { name: 'Restaurant', cost: 180000, baseIncome: 1600 },
            { name: 'Boutique de V√™tements', cost: 120000, baseIncome: 1000 },
            { name: 'Salle de Sport', cost: 300000, baseIncome: 2000 }
        ];

        if (gameState.player.unlockedBusinessTypes) {
            businessTypes.push(...gameState.player.unlockedBusinessTypes);
        }

        let formHtml = `
            <div class="panel" style="height: 100%; display: flex; flex-direction: column;">
                <h2>Cr√©er une entreprise</h2>
                <div style="flex-grow: 1; overflow-y: auto;">
                    <p>Nom de l'entreprise:</p>
                    <input type="text" id="new-business-name" placeholder="Ex: Mon Super Caf√©" style="width: 90%; margin-bottom: 1rem; background: rgba(0,0,0,0.3); border: 1px solid var(--border-color); color: white; padding: 0.5rem;">
                    <p>Type d'entreprise:</p>
                    <div class="menu-buttons">
        `;

        businessTypes.forEach(type => {
            formHtml += `<button class="menu-btn" style="font-size: 0.9rem;" onclick="createBusiness('${type.name}', ${type.cost}, ${type.baseIncome})">${type.name} (Co√ªt: ${type.cost.toLocaleString()}$)</button>`;
        });

        formHtml += `</div></div></div>`;
        phoneScreen.innerHTML = formHtml;
        phoneScreen.classList.add('active');
        phoneScreen.dataset.currentApp = 'createBusiness';
    }

    function createBusiness(type, cost, baseIncome) {
        const name = document.getElementById('new-business-name').value;
        if (!name) {
            showNotification("Veuillez donner un nom √† votre entreprise.", 'error');
            return;
        }
        if (gameState.money < cost) {
            showNotification("Fonds insuffisants pour cr√©er cette entreprise.", 'error');
            return;
        }

        removeMoney(cost, `Cr√©ation d'entreprise: ${name}`);

        const newBusiness = {
            id: 'custom_' + (gameState.customBusinesses.length + 1),
            name: name,
            type: type,
            income: baseIncome,
            employees: 0,
            stock: 100,
            equipmentLevel: 0,
            trainingLevel: 0,
            marketingBoost: null
        };

        gameState.customBusinesses.push(newBusiness);
        gameState.ownedBusinesses.push(newBusiness.id);
        showNotification(`F√©licitations ! Votre entreprise "${name}" est lanc√©e !`, 'success');
        togglePhoneApp('portfolio');
    }

    function buyLuxuryItem(itemId) {
        const item = luxuryItems.find(i => i.id === itemId);
        if (!item) return;

        const priceModifier = 1 + (50 - gameState.player.reputation) / 100;
        const baseCost = item.cost;
        const finalCost = Math.round(baseCost * priceModifier * 1.15); // 15% tax

        if (gameState.money >= finalCost) {
            removeMoney(finalCost, `Achat: ${item.name} (taxes incluses)`);
            gameState.player.inventory.push({ id: item.id, name: item.name });
            if (item.bonus.type === 'one_time') {
                item.bonus.effect();
            }
            showNotification(`Vous avez achet√©: ${item.name} !`, 'success');
            updateActionButtons();
        } else {
            showNotification("Fonds insuffisants.", 'error');
        }
    }

    function generateStockChart(history, width = 100, height = 30) {
        if (history.length < 2) {
            return `<svg width="${width}" height="${height}" viewbox="0 0 ${width} ${height}" preserveAspectRatio="none"><line x1="0" y1="${height/2}" x2="${width}" y2="${height/2}" stroke="#888" stroke-width="1"/></svg>`;
        }

        const max = Math.max(...history);
        const min = Math.min(...history);
        const range = max - min;

        if (range === 0) {
            return `<svg width="${width}" height="${height}" viewbox="0 0 ${width} ${height}" preserveAspectRatio="none"><line x1="0" y1="${height/2}" x2="${width}" y2="${height/2}" stroke="#888" stroke-width="1"/></svg>`;
        }

        const points = history.map((price, index) => {
            const x = (index / (history.length - 1)) * width;
            const y = height - ((price - min) / range) * height;
            return `${x.toFixed(2)},${y.toFixed(2)}`;
        }).join(' ');

        const lastPrice = history[history.length - 1];
        const firstPrice = history[0];
        const color = lastPrice >= firstPrice ? 'var(--success-color)' : '#e74c3c';

        return `<svg width="${width}" height="${height}" viewbox="0 0 ${width} ${height}" preserveAspectRatio="none">
                    <polyline fill="none" stroke="${color}" stroke-width="1.5" points="${points}" />
                </svg>`;
    }

    function buyStock(symbol) {
        const sharesToBuy = parseInt(prompt("Combien d'actions acheter ?", "10"));
        if (isNaN(sharesToBuy) || sharesToBuy <= 0) return;

        const stock = gameState.world.stocks.find(s => s.symbol === symbol);
        const cost = stock.price * sharesToBuy;

        if (gameState.money >= cost) {
            removeMoney(cost, `Achat de ${sharesToBuy} ${symbol}`);
            
            const holding = gameState.player.portfolio.stocks[symbol];
            if (holding) {
                const totalCost = (holding.avgPrice * holding.shares) + cost;
                holding.shares += sharesToBuy;
                holding.avgPrice = totalCost / holding.shares;
            } else {
                gameState.player.portfolio.stocks[symbol] = {
                    shares: sharesToBuy,
                    avgPrice: stock.price
                };
            }
            showNotification(`Achat de ${sharesToBuy} actions ${symbol} r√©ussi !`, 'success');
            togglePhoneApp('stocks');
        } else {
            showNotification("Fonds insuffisants.", 'error');
        }
    }

    function sellStock(symbol) {
        const holding = gameState.player.portfolio.stocks[symbol];
        if (!holding) return;

        const sharesToSell = parseInt(prompt(`Combien d'actions vendre ? (Vous avez ${holding.shares})`, holding.shares));
        if (isNaN(sharesToSell) || sharesToSell <= 0 || sharesToSell > holding.shares) return;

        const stock = gameState.world.stocks.find(s => s.symbol === symbol);
        const income = stock.price * sharesToSell;

        addMoney(income, `Vente de ${sharesToSell} ${symbol}`);
        holding.shares -= sharesToSell;

        if (holding.shares === 0) delete gameState.player.portfolio.stocks[symbol];
        
        showNotification(`Vente de ${sharesToSell} actions ${symbol} r√©ussie !`, 'success');
        togglePhoneApp('stocks');
    }

    function showRenovationOptions(businessId) {
        const property = findBusinessById(businessId);
        if (!property) return;

        if (property.availableRenovations.length === 0) {
            generateRenovationProjectsFor(property);
        }

        const phoneScreen = document.getElementById('phone-screen');
        let contentHtml = `<p>Choisissez un projet de r√©novation :</p><hr><div class="menu-buttons">`;

        const availableProjects = property.availableRenovations.filter(p => !p.completed);

        if (availableProjects.length === 0) {
            contentHtml += '<p>Toutes les r√©novations pour cette propri√©t√© ont √©t√© effectu√©es.</p>';
        } else {
            availableProjects.forEach(project => {
                contentHtml += `<button class="menu-btn" style="font-size: 0.9rem;" onclick="performRenovation('${businessId}', '${project.id}')">${project.name} (${project.cost.toLocaleString()}$)</button>`;
            });
        }

        contentHtml += `</div>`;
        document.getElementById('property-management-container').innerHTML = `<h3>R√©nover: ${property.name}</h3>${contentHtml}<button class="menu-btn" style="margin-top: 1rem;" onclick="manageProperty('${businessId}')">Retour</button>`;
        phoneScreen.dataset.currentApp = 'renovate';
    }

    function generateRenovationProjectsFor(property) {
        const allProjects = [
            { id: 'kitchen', name: 'R√©nover la cuisine', costRatio: 0.08, rentIncrease: 100, priceIncreaseRatio: 0.1 },
            { id: 'bathroom', name: 'Refaire la salle de bain', costRatio: 0.06, rentIncrease: 75, priceIncreaseRatio: 0.08 },
            { id: 'flooring', name: 'Nouveau parquet', costRatio: 0.05, rentIncrease: 50, priceIncreaseRatio: 0.06 },
            { id: 'painting', name: 'Peindre les murs', costRatio: 0.02, rentIncrease: 25, priceIncreaseRatio: 0.03 },
            { id: 'windows', name: 'Changer les fen√™tres', costRatio: 0.1, rentIncrease: 120, priceIncreaseRatio: 0.12 }
        ];

        const shuffled = allProjects.sort(() => 0.5 - Math.random());
        const selectedProjects = shuffled.slice(0, 3 + Math.floor(Math.random() * 2));

        property.availableRenovations = selectedProjects.map(p => ({
            ...p,
            cost: Math.floor((property.price * p.costRatio) / 100) * 100,
            priceIncrease: Math.floor((property.price * p.priceIncreaseRatio) / 100) * 100,
            completed: false
        }));
    }

    function performRenovation(businessId, projectId) {
        const property = findBusinessById(businessId);
        const project = property.availableRenovations.find(p => p.id === projectId);

        if (gameState.money >= project.cost) {
            removeMoney(project.cost, `R√©novation (${project.name}): ${property.name}`);
            property.rent += project.rentIncrease;
            property.price += project.priceIncrease;
            project.completed = true;
            showNotification(`La r√©novation "${project.name}" est termin√©e !`, 'success');
            showRenovationOptions(businessId);
        } else {
            showNotification("Fonds insuffisants pour cette r√©novation.", 'error');
        }
    }

    function openStaffMenu() {
        const choicesContainer = document.getElementById('staff-choices');
        choicesContainer.innerHTML = '';

        const actions = [
            { text: 'Ajouter 1,000,000,000,000$', action: () => { addMoney(1000000000000, 'Staff Cheat'); } },
            { text: 'Maximiser les besoins', action: () => { gameState.needs.energy = 100; gameState.needs.happiness = 100; gameState.needs.hunger = 100; } },
            { text: 'Maximiser les comp√©tences', action: () => { gameState.player.skills.charisma = 100; gameState.player.skills.intelligence = 100; gameState.player.skills.manual = 100; } },
            { text: 'Avancer d\'un jour', action: () => { gameState.time.day++; } },
            { text: 'D√©clencher un √©v√©nement √©co', action: () => { randomEvents[Math.floor(Math.random() * randomEvents.length)].effect(); } },
            { text: 'D√©clencher un √©v√©nement de vie', action: () => { showLifeEvent(lifeEvents[Math.floor(Math.random() * lifeEvents.length)]); } },
            { text: 'Obtenir une promotion', action: () => { if(gameState.job) checkForPromotion(); } }
        ];

        actions.forEach(act => {
            const btn = document.createElement('button');
            btn.className = 'menu-btn';
            btn.textContent = act.text;
            btn.style.fontSize = '1rem';
            btn.onclick = () => {
                act.action();
                renderUI();
                document.getElementById('staff-modal').classList.remove('active');
            };
            choicesContainer.appendChild(btn);
        });

        document.getElementById('staff-modal').classList.add('active');
    }

    function manageProperty(propertyId) {
        const property = findBusinessById(propertyId);
        if (!property) return;

        const isOwned = gameState.ownedBusinesses.includes(propertyId);
        const isRented = propertyId === gameState.player.rentedPropertyId;

        const phoneScreen = document.getElementById('phone-screen');
        const managementContainer = document.getElementById('property-management-container');

        if (property.availableRenovations.length === 0) {
            generateRenovationProjectsFor(property);
        }

        let contentHtml = `
            <h3>G√©rer: ${property.name}</h3>
            <p><strong>${isOwned && property.income > 0 ? 'Revenu de base' : (isOwned ? 'Revenu locatif' : 'Loyer mensuel')}:</strong> ${property.income > 0 ? getCustomBusinessIncome(property).toLocaleString() + '$/j' : property.rent.toLocaleString() + '$/m'}</p>
            <p><strong>Valeur estim√©e:</strong> ${property.price.toLocaleString()}$</p>
            <hr>
            <div class="menu-buttons">
                ${isOwned && property.rent > 0 ? `<button class="menu-btn" style="font-size: 0.9rem;" onclick="showRenovationOptions('${propertyId}')">R√©nover</button>` : ''}
                ${isOwned ? `<button class="menu-btn" style="font-size: 0.9rem; background-color: #e67e22;" onclick="window.showSellOffers('${propertyId}')">Mettre en vente</button>` : ''}
                ${isOwned && !isRented ? `<button class="menu-btn" style="font-size: 0.9rem;" onclick="moveIntoProperty('${propertyId}')">Emm√©nager ici</button>` : ''}
                ${!isOwned && isRented ? `<button class="menu-btn" style="font-size: 0.9rem;" onclick="window.buyBusiness('${propertyId}')">Acheter la propri√©t√© (${property.price.toLocaleString()}$)</button>` : ''}
                ${isRented && !isOwned ? `<button class="menu-btn" style="font-size: 0.9rem; background-color: #c0392b;" onclick="moveOutOfRentedProperty()">Quitter le logement</button>` : ''}
            </div>
        `;
        managementContainer.innerHTML = contentHtml;

        if (isOwned && property.income > 0) {
            manageBusiness(propertyId, managementContainer);
        }

    }

    function moveIntoProperty(propertyId) {
        gameState.player.rentedPropertyId = propertyId;
        const newHome = findBusinessById(propertyId);
        const homeZone = gameState.world.zones.find(z => z.id === 'home');
        homeZone.name = `Mon ${newHome.name}`;
        showNotification(`Vous avez emm√©nag√© dans votre propri√©t√©: ${newHome.name}.`, 'success');
        togglePhoneApp('properties');
    }

    function moveOutOfRentedProperty() {
        gameState.player.rentedPropertyId = null;
        showNotification("Vous avez quitt√© votre logement. Vous √™tes maintenant sans-abri.", 'error');
        togglePhoneApp('properties');
    }

    function getCustomBusinessIncome(business) {
        let income = business.income;
        income *= (1 + (business.equipmentLevel || 0) * 0.2);
        const employeeBonus = 1 + (business.employees || 0) * (0.5 + (business.trainingLevel || 0) * 0.1);
        income *= employeeBonus;
        if (business.marketingBoost) {
            income *= 1.5; 
        }
        return Math.floor(income);
    }

    function manageBusiness(businessId, container) {
        const business = findBusinessById(businessId) || gameState.customBusinesses.find(b => b.id === businessId);
        if (!business) return;

        const equipmentCost = (50000 * ((business.equipmentLevel || 0) + 1));
        const trainingCost = (25000 * ((business.trainingLevel || 0) + 1));
        const stockCost = 500;

        let contentHtml = `
            <h3>G√©rer: ${business.name}</h3>
            <p><strong>Revenu Actuel:</strong> ${getCustomBusinessIncome(business).toLocaleString()}$/j</p>
            <p><strong>Employ√©s:</strong> ${business.employees}</p>
            ${business.stock !== undefined ? `<p><strong>Stock:</strong> ${Math.round(business.stock)} / 100</p>` : ''}
            <hr>
            <div class="menu-buttons">
                <button class="menu-btn" style="font-size: 0.9rem;" onclick="hireEmployee('${business.id}')">Embaucher (Co√ªt mensuel: 1500$)</button>
                <button class="menu-btn" style="font-size: 0.9rem;" onclick="upgradeEquipment('${business.id}')" ${gameState.money < equipmentCost ? 'disabled' : ''}>Am√©liorer l'√©quipement (${equipmentCost.toLocaleString()}$)</button>
                <button class="menu-btn" style="font-size: 0.9rem;" onclick="trainStaff('${business.id}')" ${business.employees === 0 || gameState.money < trainingCost ? 'disabled' : ''}>Former le personnel (${trainingCost.toLocaleString()}$)</button>
                <button class="menu-btn" style="font-size: 0.9rem;" onclick="runMarketing('${business.id}')" ${business.marketingBoost || gameState.money < 5000 ? 'disabled' : ''}>Marketing (5000$ pour 30j)</button>
                ${business.stock !== undefined ? `<button class="menu-btn" style="font-size: 0.9rem;" onclick="buyStockForBusiness('${business.id}')" ${gameState.money < stockCost ? 'disabled' : ''}>Acheter du Stock (${stockCost.toLocaleString()}$)</button>` : ''}
            </div>
        `;
        
        container.innerHTML = contentHtml;
    }

    function hireEmployee(businessId) {
        const business = findBusinessById(businessId);
        if (!business) return;
        business.employees++;
        showNotification(`Vous avez embauch√© un nouvel employ√© pour ${business.name} !`, 'success');
        manageProperty(businessId);
    }

    function buyStockForBusiness(businessId) {
        const business = findBusinessById(businessId);
        if (!business || gameState.money < 2000) return;
        removeMoney(2000, `Achat de stock: ${business.name}`);
        business.stock = Math.min(100, (business.stock || 0) + 50);
        showNotification(`Stock r√©approvisionn√© pour ${business.name}.`, 'success');
        manageProperty(businessId);
    }

    function runMarketing(businessId) {
        const business = findBusinessById(businessId);
        if (!business || business.marketingBoost) return;
        const cost = 10000;

        if (gameState.money >= cost) {
            removeMoney(cost, `Campagne Marketing: ${business.name}`);
            business.marketingBoost = { duration: 30 };
            showNotification(`La campagne marketing pour ${business.name} est lanc√©e !`, 'success');
            manageProperty(businessId);
        } else {
            showNotification("Fonds insuffisants pour la campagne marketing.", 'error');
        }
    }

    function upgradeEquipment(businessId) {
        const business = findBusinessById(businessId);
        if (!business) return;
        const cost = 50000 * ((business.equipmentLevel || 0) + 1);
        if (gameState.money >= cost) {
            removeMoney(cost, `√âquipement: ${business.name}`);
            business.equipmentLevel = (business.equipmentLevel || 0) + 1;
            showNotification(`L'√©quipement de ${business.name} a √©t√© am√©lior√© !`, 'success');
            manageProperty(businessId);
        } else {
            showNotification("Fonds insuffisants.", 'error');
        }
    }

    function trainStaff(businessId) {
        const business = findBusinessById(businessId);
        if (!business || business.employees === 0) return;
        const cost = 25000 * ((business.trainingLevel || 0) + 1);
        if (gameState.money >= cost) {
            removeMoney(cost, `Formation: ${business.name}`);
            business.trainingLevel = (business.trainingLevel || 0) + 1;
            showNotification(`Le personnel de ${business.name} est maintenant plus comp√©tent !`, 'success');
            manageProperty(businessId);
        } else {
            showNotification("Fonds insuffisants.", 'error');
        }
    }

    function renderVehicleList() {
        const actionButtonsContainer = document.getElementById('contextual-actions');
        actionButtonsContainer.innerHTML = '';

        const backBtn = document.createElement('button');
        backBtn.className = 'menu-btn';
        backBtn.textContent = 'Retour';
        backBtn.style.marginBottom = '1rem';
        backBtn.style.backgroundColor = 'rgba(0, 0, 0, 0.3)';
        backBtn.onclick = () => updateActionButtons();
        actionButtonsContainer.appendChild(backBtn);

        const categories = ['Toutes', ...new Set(vehicleData.map(v => v.category))];
        
        const filterContainer = document.createElement('div');
        filterContainer.style.display = 'flex';
        filterContainer.style.gap = '1rem';
        filterContainer.style.flexWrap = 'wrap';
        filterContainer.style.marginBottom = '1rem';

        categories.forEach(category => {
            const btn = document.createElement('button');
            btn.textContent = category;
            btn.className = 'menu-btn';
            btn.style.padding = '0.5rem 1rem';
            btn.style.fontSize = '0.9rem';
            btn.onclick = () => {
                document.querySelectorAll('.vehicle-listing').forEach(el => {
                    el.style.display = (category === 'Toutes' || el.dataset.category === category) ? 'flex' : 'none';
                });
            };
            filterContainer.appendChild(btn);
        });
        actionButtonsContainer.appendChild(filterContainer);

        vehicleData.forEach(vehicle => {
            const vehicleEl = document.createElement('div');
            vehicleEl.className = 'business-listing vehicle-listing';
            vehicleEl.dataset.category = vehicle.category;

            vehicleEl.innerHTML = `
                <div>
                    <h4>${vehicle.name} <small>(${vehicle.brand})</small></h4>
                    <p class="business-details">Bonus Bonheur: +${vehicle.happinessBonus}</p>
                </div>
                <button class="menu-btn" onclick="buyVehicle('${vehicle.id}')" ${gameState.money < vehicle.cost ? 'disabled' : ''}>
                    Acheter (${vehicle.cost.toLocaleString()}$)
                </button>
            `;
            actionButtonsContainer.appendChild(vehicleEl);
        });
    }

    function buyVehicle(vehicleId) {
        const vehicle = vehicleData.find(v => v.id === vehicleId);
        if (!vehicle) return;

        const priceModifier = 1 + (50 - gameState.player.reputation) / 150;
        const baseCost = vehicle.cost;
        const finalCost = Math.round(baseCost * priceModifier * 1.15); // 15% tax

        if (gameState.money >= finalCost) {
            removeMoney(finalCost, `Achat: ${vehicle.name} (taxes incluses)`);
            if (gameState.player.vehicle) {
                const oldVehicle = vehicleData.find(v => v.id === gameState.player.vehicle.id);
                addMoney(oldVehicle.cost * 0.7, `Reprise: ${oldVehicle.name}`);
            }
            gameState.player.vehicle = { id: vehicle.id, color: 'Gris' };
            showNotification(`F√©licitations pour votre nouvelle ${vehicle.name} !`, 'success');
            renderVehicleList();
        } else {
            showNotification("Fonds insuffisants.", 'error');
        }
    }

    function paintVehicle() {
        const cost = 1500;
        if (gameState.money >= cost) {
            removeMoney(cost, 'Peinture v√©hicule');
            const colors = ['Rouge', 'Bleu', 'Noir', 'Blanc', 'Vert'];
            gameState.player.vehicle.color = colors[Math.floor(Math.random() * colors.length)];
            showNotification(`Votre v√©hicule est maintenant ${gameState.player.vehicle.color} !`, 'success');
        } else {
            showNotification("Fonds insuffisants pour repeindre.", 'error');
        }
    }

    function sellCurrentVehicle() {
        if (!gameState.player.vehicle) return;

        const currentVehicle = vehicleData.find(v => v.id === gameState.player.vehicle.id);
        const sellPrice = Math.floor(currentVehicle.cost * 0.7);

        addMoney(sellPrice, `Vente de v√©hicule: ${currentVehicle.name}`);
        showNotification(`Vous avez vendu votre ${currentVehicle.name} pour ${sellPrice.toLocaleString()}$.`, 'success');
        
        gameState.player.vehicle = null;
        updateActionButtons();
    }

    function showTravelDestinations() {
        const actionButtonsContainer = document.getElementById('contextual-actions');
        actionButtonsContainer.innerHTML = '';

        const backBtn = document.createElement('button');
        backBtn.className = 'menu-btn';
        backBtn.textContent = 'Retour';
        backBtn.style.marginBottom = '1rem';
        backBtn.onclick = () => updateActionButtons();
        actionButtonsContainer.appendChild(backBtn);

        const destinations = [
            { name: 'Tropicana (√éle Paradisiaque)', cost: 3500, duration: 5, activities: [{ name: 'Faire de la plong√©e', happiness: 40 }, { name: 'Se relaxer sur la plage', happiness: 50 }] },
            { name: 'Zenithia (M√©gapole Futuriste)', cost: 5000, duration: 4, activities: [{ name: 'Faire du shopping de luxe', happiness: 35 }, { name: 'Visiter un mus√©e de technologie', happiness: 30 }] },
            { name: 'Montagnia (Retraite en Montagne)', cost: 2500, duration: 7, activities: [{ name: 'Faire une longue randonn√©e', happiness: 45 }, { name: 'M√©diter au sommet', happiness: 55 }] }
        ];

        destinations.forEach(dest => {
            const btn = document.createElement('button');
            btn.className = 'menu-btn';
            const finalCost = Math.round(dest.cost * 1.15);
            btn.textContent = `Voyager √† ${dest.name} (${dest.cost.toLocaleString()}$ + taxes)`;
            btn.onclick = () => travelToDestination(dest);
            if (gameState.money < finalCost) btn.disabled = true;
            actionButtonsContainer.appendChild(btn);
        });
    }

    function travelToDestination(destination) { 
        const finalCost = Math.round(destination.cost * 1.15);
        if (gameState.money < finalCost) {
            showNotification("Fonds insuffisants pour ce voyage.", 'error');
            return;
        }
        removeMoney(finalCost, `Voyage √† ${destination.name} (taxes incluses)`);

        const actionButtonsContainer = document.getElementById('contextual-actions');
        actionButtonsContainer.innerHTML = `<h3>Bienvenue √† ${destination.name} !</h3><p>Que voulez-vous faire pendant votre s√©jour de ${destination.duration} jours ?</p>`;

        destination.activities.forEach(activity => {
            const btn = document.createElement('button');
            btn.className = 'menu-btn';
            btn.textContent = `${activity.name} (+${activity.happiness} bonheur)`;
            btn.onclick = () => {
                for (let i = 0; i < destination.duration; i++) { gameState.time.day++; }
                gameState.needs.energy = 100;
                gameState.needs.happiness = Math.min(100, gameState.needs.happiness + activity.happiness);
                showNotification(`Vous revenez de vacances, frais et dispos !`, 'success');
                updateActionButtons();
            };
            actionButtonsContainer.appendChild(btn);
        });
    }

    function seeDoctor() {
        const cost = 250;
        if (gameState.money >= cost) {
            removeMoney(cost, "Consultation m√©dicale");
            advanceTime(1);
            if (gameState.player.sickness) {
                showNotification(`Le m√©decin vous a soign√© ! Vous vous sentez d√©j√† mieux.`, 'success');
                gameState.player.sickness = null;
                gameState.needs.health = Math.min(100, gameState.needs.health + 20);
            } else {
                showNotification("Le m√©decin dit que vous √™tes en parfaite sant√©.", 'info');
                gameState.needs.health = 100;
            }
        } else {
            showNotification("Fonds insuffisants pour voir un m√©decin.", 'error');
        }
    }

    function showSellableItems() {
        const actionButtonsContainer = document.getElementById('contextual-actions');
        actionButtonsContainer.innerHTML = '';

        const backBtn = document.createElement('button');
        backBtn.className = 'menu-btn';
        backBtn.textContent = 'Retour';
        backBtn.style.marginBottom = '1rem';
        backBtn.onclick = () => updateActionButtons();
        actionButtonsContainer.appendChild(backBtn);

        const sellableItems = gameState.player.inventory.filter(item => luxuryItems.some(li => li.id === item.id));
        sellableItems.forEach(item => {
            const luxuryItem = luxuryItems.find(li => li.id === item.id);
            const sellPrice = Math.floor(luxuryItem.cost * 0.7);
            const btn = document.createElement('button');
            btn.className = 'menu-btn';
            btn.textContent = `Vendre ${item.name} (${sellPrice.toLocaleString()}$)`;
            btn.onclick = () => {
                addMoney(sellPrice, `Vente: ${item.name}`);
                gameState.player.inventory = gameState.player.inventory.filter(i => i.id !== item.id);
                showNotification(`Vous avez vendu votre ${item.name}.`, 'success');
                updateActionButtons();
            };
            actionButtonsContainer.appendChild(btn);
        });
    }

    function showResearchProjects() {
        const actionButtonsContainer = document.getElementById('contextual-actions');
        actionButtonsContainer.innerHTML = '';

        const backBtn = document.createElement('button');
        backBtn.className = 'menu-btn';
        backBtn.textContent = 'Retour';
        backBtn.style.marginBottom = '1rem';
        backBtn.onclick = () => updateActionButtons();
        actionButtonsContainer.appendChild(backBtn);

        if (gameState.player.researchProject) {
            const project = researchData.find(p => p.id === gameState.player.researchProject.projectId);
            actionButtonsContainer.innerHTML += `<p>Recherche en cours : ${project.name}. Jours restants : ${gameState.player.researchProject.daysRemaining}</p>`;
            return;
        }

        researchData.forEach(project => {
            const btn = document.createElement('button'); 
            btn.className = 'menu-btn';
            btn.innerHTML = `<h4>${project.name} (${project.cost.toLocaleString()}$)</h4><p class="business-details">${project.description}</p>`;
            btn.onclick = () => startResearch(project.id);
            if (gameState.money < project.cost || gameState.player.unlockedBusinessTypes.some(b => b.name === project.reward.business?.name)) {
                btn.disabled = true;
            }
            actionButtonsContainer.appendChild(btn);
        });
    }

    function startResearch(projectId) {
        const project = researchData.find(p => p.id === projectId);
        if (gameState.money >= project.cost && !gameState.player.researchProject) {
            removeMoney(project.cost, `Recherche: ${project.name}`);
            gameState.player.researchProject = {
                projectId: projectId,
                daysRemaining: project.durationDays
            };
            showNotification(`La recherche sur "${project.name}" a commenc√© !`, 'success');
            updateActionButtons();
        }
    }

    function completeResearch(projectId) {
        const project = researchData.find(p => p.id === projectId);
        if (!project) return;

        const reward = project.reward;
        if (reward.type === 'new_business') {
            gameState.player.unlockedBusinessTypes.push(reward.business);
            showNotification(`Recherche termin√©e ! Vous pouvez maintenant cr√©er des "${reward.business.name}".`, 'success');
        } else if (reward.type === 'stock_boost') {
            const stock = gameState.world.stocks.find(s => s.symbol === reward.symbol);
            if (stock) {
                stock.price *= reward.multiplier;
                showNotification(`Recherche termin√©e ! Le secteur "${stock.name}" a re√ßu un coup de pouce majeur.`, 'success');
            }
        } else if (reward.type === 'property_boost') {
            gameState.world.zones.forEach(zone => {
                if (zone.businesses) {
                    zone.businesses.forEach(business => {
                        if (business.rent > 0) {
                            business.price = Math.round(business.price * reward.multiplier);
                        }
                    });
                }
            });
            showNotification(`Recherche termin√©e ! La valeur de l'immobilier a augment√©.`, 'success');
        }

        gameState.player.researchProject = null;
    }

    function orderFood(restaurantId, foodId) {
        const restaurant = restaurantData[restaurantId];
        if (!restaurant) return;
        const food = restaurant.menu.find(f => f.id === foodId);
        if (!food) return;

        if (gameState.money >= food.cost) {
            removeMoney(food.cost, `Commande: ${food.name}`);
            gameState.needs.hunger = Math.min(100, gameState.needs.hunger + food.hungerBonus);
            gameState.needs.happiness = Math.min(100, gameState.needs.happiness + food.happinessBonus);
            advanceTime(0.5);
            showNotification(`Votre commande de ${food.name} est arriv√©e !`, 'success');
            togglePhoneApp('delivery');
        } else {
            showNotification("Fonds insuffisants pour cette commande.", 'error');
        }
    }

    function showRestaurantMenu(restaurantId) {
        const restaurant = restaurantData[restaurantId];
        if (!restaurant) return;

        const phoneScreen = document.getElementById('phone-screen');
        let menuHtml = `<button class="menu-btn" style="font-size: 0.9rem; margin-bottom: 1rem;" onclick="togglePhoneApp('delivery')">Retour aux restaurants</button>`;

        restaurant.menu.forEach(food => {
            menuHtml += `
                <div class="business-listing">
                    <div>
                        <strong>${food.name}</strong><br>
                        <small>Prix: ${food.cost}$ | Sati√©t√©: +${food.hungerBonus} | Bonheur: +${food.happinessBonus}</small>
                    </div>
                    <button class="menu-btn" style="font-size:0.8rem; padding:0.4rem 0.8rem;" onclick="orderFood('${restaurantId}', '${food.id}')">Commander</button>
                </div>`;
        });

        phoneScreen.innerHTML = `<div class="panel" style="height: 100%; display: flex; flex-direction: column;"><h2>${restaurant.name}</h2><div style="flex-grow: 1; overflow-y: auto;">${menuHtml}</div></div>`;
    }

    function showHomeCustomization() {
        const actionButtonsContainer = document.getElementById('contextual-actions');
        actionButtonsContainer.innerHTML = '';

        const backBtn = document.createElement('button');
        backBtn.className = 'menu-btn';
        backBtn.textContent = 'Retour';
        backBtn.style.marginBottom = '1rem';
        backBtn.onclick = () => updateActionButtons();
        actionButtonsContainer.appendChild(backBtn);

        const styles = [
            { id: 'moderne', name: 'Style Moderne', cost: 5000, happinessBonus: 5 },
            { id: 'industriel', name: 'Style Industriel', cost: 7000, happinessBonus: 7 },
            { id: 'cosy', name: 'Style Cosy', cost: 4000, happinessBonus: 4 }
        ];

        styles.forEach(style => {
            if (gameState.player.homeStyle !== style.id) {
                const btn = document.createElement('button');
                btn.className = 'menu-btn';
                btn.textContent = `Acheter ${style.name} (${style.cost.toLocaleString()}$)`;
                btn.onclick = () => buyHomeStyle(style);
                if (gameState.money < style.cost) btn.disabled = true;
                actionButtonsContainer.appendChild(btn);
            }
        });

        const styleInfo = document.createElement('p');
        styleInfo.style.marginTop = '1rem';
        styleInfo.textContent = `Style actuel : ${gameState.player.homeStyle}`;
        actionButtonsContainer.appendChild(styleInfo);
    }

    function buyHomeStyle(style) {
        if (gameState.money >= style.cost) {
            removeMoney(style.cost, `D√©coration: ${style.name}`);
            gameState.player.homeStyle = style.id;
            gameState.needs.happiness = Math.min(100, gameState.needs.happiness + style.happinessBonus);
            showNotification(`Votre appartement a maintenant un ${style.name} !`, 'success');
            updateActionButtons();
        } else {
            showNotification("Fonds insuffisants pour cette d√©coration.", 'error');
        }
    }

    function showEatAtHomeOptions() {
        const homeMeals = [ 
            { name: 'P√¢tes au beurre', cost: 8, hunger: 40 },
            { name: 'Omelette', cost: 12, hunger: 50 }
        ];
        const actionButtonsContainer = document.getElementById('contextual-actions');
        actionButtonsContainer.innerHTML = '';

        const backBtn = document.createElement('button');
        backBtn.className = 'menu-btn';
        backBtn.textContent = 'Retour';
        backBtn.style.marginBottom = '1rem';
        backBtn.onclick = () => updateActionButtons();
        actionButtonsContainer.appendChild(backBtn);

        homeMeals.forEach(meal => {
            const btn = document.createElement('button');
            btn.className = 'menu-btn';
            btn.textContent = `${meal.name} (${meal.cost}$)`;
            btn.onclick = () => { removeMoney(meal.cost, `Repas: ${meal.name}`); gameState.needs.hunger = Math.min(100, gameState.needs.hunger + meal.hunger); advanceTime(0.5); showNotification('Bon app√©tit !', 'success'); updateActionButtons(); };
            actionButtonsContainer.appendChild(btn);
        });
    }

    function showPartyOptions() {
        const actionButtonsContainer = document.getElementById('contextual-actions');
        actionButtonsContainer.innerHTML = '';

        const backBtn = document.createElement('button');
        backBtn.className = 'menu-btn';
        backBtn.textContent = 'Retour';
        backBtn.style.marginBottom = '1rem';
        backBtn.onclick = () => updateActionButtons();
        actionButtonsContainer.appendChild(backBtn);

        const parties = [
            { id: 'friends_party', name: 'Petite soir√©e entre amis', cost: 800, time: 3, effects: { happiness: 20, friend_rel: 15, reputation: 2 } },
            { id: 'luxury_party', name: 'Grande f√™te de luxe', cost: 5000, time: 5, effects: { happiness: 40, friend_rel: 20, reputation: 10 } },
            { id: 'networking_event', name: 'R√©seautage professionnel', cost: 2500, time: 4, effects: { happiness: 10, reputation: 8 } }
        ];

        parties.forEach(party => {
            const btn = document.createElement('button');
            btn.className = 'menu-btn';
            btn.textContent = `${party.name} (${party.cost.toLocaleString()}$)`;
            btn.onclick = () => hostParty(party);
            if (gameState.money < party.cost) btn.disabled = true;
            actionButtonsContainer.appendChild(btn);
        });
    }

    function hostParty(party) {
        if (gameState.money < party.cost) {
            showNotification("Fonds insuffisants pour organiser cet √©v√©nement.", 'error');
            return;
        }
        removeMoney(party.cost, `√âv√©nement: ${party.name}`);
        
        gameState.needs.happiness = Math.min(100, gameState.needs.happiness + party.effects.happiness);
        if (party.effects.friend_rel) {
            gameState.player.relationships.friend.relationship = Math.min(100, gameState.player.relationships.friend.relationship + party.effects.friend_rel);
        }
        gameState.player.reputation = Math.min(100, gameState.player.reputation + party.effects.reputation);
        
        advanceTime(party.time);
        showNotification(`Votre "${party.name}" a √©t√© un grand succ√®s !`, 'success');
        updateActionButtons();
    }

    function checkObjectives() {
        for (const categoryId in objectivesData) {
            objectivesData[categoryId].objectives.forEach(obj => {
                if (!gameState.player.completedObjectives.includes(obj.id) && obj.condition(gameState)) {
                    gameState.player.completedObjectives.push(obj.id);
                    showNotification(`Objectif atteint : ${obj.text} !`, 'success');
                    if (obj.reward.money) {
                        addMoney(obj.reward.money, `R√©compense: ${obj.text}`);
                    }
                    if (obj.reward.reputation) {
                        gameState.player.reputation = Math.min(100, gameState.player.reputation + obj.reward.reputation);
                    }
                    if (obj.reward.happiness) {
                        gameState.needs.happiness = Math.min(100, gameState.needs.happiness + obj.reward.happiness);
                    }
                }
            });
        }
    }

    document.addEventListener('DOMContentLoaded', initialize);
    </script>
  
</body>
</html>
